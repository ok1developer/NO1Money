<html lang="th">
<head>
    <meta charset="UTF-8">
    <!-- Updated viewport to prevent zooming and ensure proper scaling -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>ระบบสินเชื่อ</title>
    <style>
        @font-face {
            font-family: 'LINESeedSansTH';
            src: url('https://cdn.glitch.global/47bd20a5-ea68-4eee-b852-538d3eb2c0a4/LINESeedSansTH_W_Rg.woff?v=1729614138182') format('woff');
            font-weight: normal;
        }
        @font-face {
            font-family: 'LINESeedSansTH';
            src: url('https://cdn.glitch.global/47bd20a5-ea68-4eee-b852-538d3eb2c0a4/LINESeedSansTH_W_Bd.woff?v=1731156180172') format('woff');
            font-weight: bold;
        }
    </style>
    <!-- Ensure Font Awesome is loaded -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #3a86ff;
            --secondary-color: #4cc9f0;
            --accent-color: #f72585;
            --success-color: #4ad66d;
            --warning-color: #ffbe0b; /* Used for postpone */
            --danger-color: #ef233c;  /* Used for late fee */
            --info-color: #4895ef;
            --text-dark: #2b2d42;
            --text-light: #8d99ae;
            --bg-light: #f8f9fa;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-slow: all 1s ease-in-out; /* For background gradient */
            --border-radius: 12px;
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);

            /* Contract Type Colors */
            --type-mobile-color: #4361ee;
            --type-refinance-color: #7209b7;
            --type-pawn-color: #f77f00;
            --type-online_pawn-color: #ff9e00;
            --type-other-color: #6c757d;

            /* Time-based Gradients */
            --gradient-morning: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            --gradient-afternoon: linear-gradient(135deg, #4cc9f0 0%, #3a86ff 100%); /* Default */
            --gradient-evening: linear-gradient(135deg, #ffbe0b 0%, #f72585 100%);
            --gradient-night: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'LINESeedSansTH', sans-serif; }
        html, body { height: 100%; }
        body { background-color: var(--bg-light); color: var(--text-dark); line-height: 1.6;
            /* Prevent elastic scrolling / pull-to-refresh on touch devices */
             overscroll-behavior-y: contain;
             /* Prevent zooming via double-tap */
             touch-action: manipulation;
        }
        /* Prevent text selection which can happen during fast taps */
        body { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }

        /* PIN Code Screen Styles */
        .pin-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-light); background-image: radial-gradient(circle at 5% 10%, rgba(58, 134, 255, 0.08) 0%, transparent 40%), radial-gradient(circle at 95% 90%, rgba(76, 201, 240, 0.08) 0%, transparent 40%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; padding: 20px; opacity: 1; visibility: visible; transition: opacity 0.3s ease-out, visibility 0s linear 0s; }
        .pin-overlay.hidden { opacity: 0; visibility: hidden; transition: opacity 0.3s ease-out, visibility 0s linear 0.3s; pointer-events: none; }
        .pin-container { background-color: white; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--card-shadow); text-align: center; max-width: 350px; width: 90%; }
        .pin-title { font-size: 1.4rem; font-weight: bold; color: var(--primary-color); margin-bottom: 15px; }
        .pin-instructions { font-size: 0.9rem; color: var(--text-light); margin-bottom: 10px; } /* Reduced margin */
        /* PIN Status Message */
        .pin-status-message {
            font-size: 0.85rem;
            height: 1.2em;
            margin-bottom: 15px; /* Space before PIN dots */
            font-weight: bold;
            color: var(--info-color); /* Default color */
            transition: color 0.3s ease;
        }
        .pin-status-message.status-error { color: var(--danger-color); }
        .pin-status-message.status-success { color: var(--success-color); }

        .pin-display { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; height: 20px; }
        .pin-dot { width: 15px; height: 15px; background-color: #e0e0e0; border-radius: 50%; transition: background-color 0.2s ease; }
        .pin-dot.filled { background-color: var(--primary-color); }
        .pin-error { color: var(--danger-color); font-size: 0.85rem; height: 1.2em; margin-bottom: 15px; font-weight: bold; display: none; } /* Hide the old error message */
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .keypad button { font-family: 'LINESeedSansTH', sans-serif; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 50%; width: 60px; height: 60px; font-size: 1.5rem; font-weight: bold; color: var(--text-dark); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; display: flex; justify-content: center; align-items: center; margin: 0 auto; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            /* Prevent double-tap zoom on buttons */
            touch-action: manipulation;
         }
        .keypad button:hover { background-color: #e9ecef; }
        .keypad button:active { background-color: #d6d8db; transform: scale(0.95); }
        .keypad .key-clear, .keypad .key-backspace { font-size: 1.2rem; background-color: #fff1f3; color: var(--danger-color); border-color: #ffe0e3; }
        .keypad .key-clear:hover, .keypad .key-backspace:hover { background-color: #ffe3e7; }
        .keypad .key-clear:active, .keypad .key-backspace:active { background-color: #fdd8de; transform: scale(0.95); }
        .keypad .key-placeholder { visibility: hidden; }

        /* Main Content Visibility */
        .main-app-content { opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in, visibility 0s linear 0.5s; padding-top: 60px; padding-bottom: 80px; background-image: radial-gradient(circle at 10% 20%, rgba(58, 134, 255, 0.03) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(76, 201, 240, 0.03) 0%, transparent 20%); }
        body.content-visible .main-app-content { opacity: 1; visibility: visible; transition: opacity 0.3s ease-out, visibility 0s linear 0s; }
        .app-header, .container, .fab-container, .bottom-nav, .slip-modal { display: none; }
        body.content-visible .app-header { display: flex; }
        body.content-visible .container { display: block; }
        body.content-visible .fab-container { display: block; }
        body.content-visible .fab { display: flex; }
        body.content-visible .bottom-nav { display: block; }

        /* Enhanced Loading Overlay */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-out, visibility 0s linear 0.3s; }
        .loading-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.1s ease-in, visibility 0s linear 0s; }
        .spinner { width: 55px; height: 55px; border: 4px solid rgba(58, 134, 255, 0.1); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite, pulse-scale 1.5s ease-in-out infinite alternate; /* Added pulse */ position: relative; }
        .spinner::after { content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; border-radius: 50%; border: 4px solid transparent; border-top-color: var(--secondary-color); animation: spin 1.5s linear infinite reverse; /* Spin opposite direction */ }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse-scale { /* New animation */
            0% { transform: scale(0.9); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        /* App Header */
        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: white; border-bottom: 1px solid rgba(0, 0, 0, 0.05); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); align-items: center; padding: 0 15px; z-index: 1000; backdrop-filter: blur(5px); }
        .app-header-left { flex-shrink: 0; }
        .app-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(58, 134, 255, 0.1); display: block; transition: var(--transition); }
        .app-avatar:hover { transform: scale(1.05); box-shadow: 0 0 0 2px var(--primary-color); }
        .app-header-center { flex-grow: 1; text-align: center; display: flex; justify-content: center; align-items: center; min-width: 50px; padding: 0 10px; }
        .app-logo { height: 30px; width: auto; display: block; transition: var(--transition); }
        .app-header-right { display: flex; align-items: center; gap: 15px; flex-shrink: 0; }
        /* Notification styles */
        .notification-wrapper { position: relative; display: flex; align-items: center; }
        .notification-bell { display: flex; align-items: center; font-size: 1.3rem; color: var(--text-dark); cursor: pointer; position: relative; transition: var(--transition); }
        .notification-bell:hover { color: var(--primary-color); transform: scale(1.1); }
        .notification-badge { position: absolute; top: -5px; right: -8px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.65rem; font-weight: bold; display: flex; justify-content: center; align-items: center; line-height: 1; border: 2px solid white; animation: pulse-badge 1.5s infinite cubic-bezier(0.66, 0, 0, 1); }
        .notification-badge.hidden { display: none; }
        @keyframes pulse-badge {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 35, 60, 0.4); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 6px rgba(239, 35, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 35, 60, 0); }
        }
        .notification-panel { display: none; position: absolute; top: calc(100% + 10px); right: -10px; width: 320px; max-width: calc(100vw - 30px); background-color: white; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); z-index: 1100; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); flex-direction: column; }
        .notification-panel.active { display: flex; opacity: 1; visibility: visible; transform: translateY(0); }
        .notification-header { padding: 12px 15px; border-bottom: 1px solid rgba(0, 0, 0, 0.05); flex-shrink: 0; }
        .notification-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .notification-tab-btn { flex: 1; padding: 6px 10px; font-size: 0.8rem; font-weight: bold; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 6px; background-color: #f8f9fa; color: var(--text-light); cursor: pointer; transition: var(--transition); text-align: center; }
        .notification-tab-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .notification-title-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .notification-title-bar span { font-weight: bold; font-size: 0.95rem; color: var(--text-dark); }
        .notification-clear-btn { font-size: 0.75rem; color: var(--primary-color); background: none; border: none; cursor: pointer; font-weight: normal; padding: 3px 5px; transition: var(--transition); }
        .notification-clear-btn:hover { text-decoration: underline; color: var(--accent-color); }
        .notification-list-container { max-height: 300px; overflow-y: auto; flex-grow: 1; position: relative; }
        .notification-list { list-style: none; padding: 0; margin: 0; width: 100%; display: none; }
        .notification-list.active { display: block; }
        .notification-item { padding: 12px 15px; border-bottom: 1px solid rgba(0, 0, 0, 0.05); display: flex; gap: 12px; align-items: flex-start; cursor: pointer; transition: var(--transition); }
        .notification-item:last-child { border-bottom: none; }
        .notification-item:hover { background-color: rgba(58, 134, 255, 0.05); }
        .notification-item.unread { background-color: rgba(58, 134, 255, 0.08); font-weight: bold; }
        .notification-item-icon { display: inline-block; font-size: 1.1rem; margin-top: 2px; flex-shrink: 0; width: 20px; text-align: center; }
        .notification-item-icon.icon-due { color: var(--warning-color); } .notification-item-icon.icon-paid { color: var(--success-color); } .notification-item-icon.icon-promo { color: var(--accent-color); } .notification-item-icon.icon-closed { color: var(--success-color); }
        .notification-item-content { flex-grow: 1; }
        .notification-item-text { font-size: 0.85rem; line-height: 1.4; color: var(--text-dark); margin-bottom: 3px; }
        .notification-item-time { font-size: 0.75rem; color: var(--text-light); }
        .app-close-button { background: none; border: none; font-size: 1.4rem; color: var(--text-dark); cursor: pointer; padding: 8px; line-height: 1; border-radius: 50%; transition: var(--transition); display: flex; align-items: center; justify-content: center; }
        .app-close-button:hover { background-color: rgba(239, 35, 60, 0.1); color: var(--danger-color); transform: rotate(90deg); }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Greeting Header */
        .header-container { margin-bottom: 25px; }
        .user-greeting {
            color: white; padding: 25px 30px; border-radius: var(--border-radius); box-shadow: 0 8px 25px rgba(58, 134, 255, 0.2); width: 100%; position: relative; overflow: hidden; display: flex; flex-direction: column; gap: 18px; border: none; margin-bottom: 25px;
            transition: background 1s ease-in-out, transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .user-greeting.time-morning { background: var(--gradient-morning); }
        .user-greeting.time-afternoon { background: var(--gradient-afternoon); }
        .user-greeting.time-evening { background: var(--gradient-evening); }
        .user-greeting.time-night { background: var(--gradient-night); }

        .user-greeting::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 70%); transform: rotate(-30deg); animation: shimmer 8s infinite linear; z-index: 0; }
        .user-greeting > * { position: relative; z-index: 1; }
        .user-greeting:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(58, 134, 255, 0.3); }
        .user-greeting-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            width: 100%;
            gap: 20px;
        }
        .greeting-avatar {
            width: 75px;
            height: 75px;
            border-radius: 50%; object-fit: cover; border: 3px solid rgba(255, 255, 255, 0.6); flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            order: 2;
        }
        .greeting-text { z-index: 1; flex-grow: 1; order: 1; }
        .greeting-message-container { display: flex; flex-direction: column; }
        .greeting-time {
            font-size: 1rem; font-weight: 400; opacity: 1; /* Ensure full opacity */
            display: flex; align-items: center; margin-bottom: 2px;
            color: white; /* Force white color */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); /* Add shadow for contrast */
        }
        #greeting-icon {
            margin-right: 8px;
            font-size: 1.2em;
            color: white; /* Force white color */
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.6)); /* Add shadow for contrast */
            transition: transform 0.5s ease;
            display: inline-block;
            animation: pulse-icon 2.5s infinite ease-in-out;
        }
        /* Remove time-based icon colors */
        /* #greeting-icon.icon-morning { color: #ffeca8; }
        #greeting-icon.icon-afternoon { color: #ffe066; }
        #greeting-icon.icon-evening { color: #ffb399; }
        #greeting-icon.icon-night { color: #d1d9e6; } */

        @keyframes pulse-icon {
          0%, 100% { transform: scale(1); opacity: 0.9; }
          50% { transform: scale(1.1); opacity: 1; }
        }

        #greeting-text-span { display: inline-block; }

        .greeting-text .user-name {
            font-size: 1.8rem; font-weight: 700; display: block;
            color: white; /* Force white color */
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); /* Add shadow for contrast */
            line-height: 1.2;
        }
        .greeting-text p {
            font-weight: normal; opacity: 0.9; /* Slightly increased opacity */
            font-size: 0.9rem; margin-bottom: 10px; margin-top: 5px;
            color: white; /* Force white color */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4); /* Add shadow for contrast */
        }
        .greeting-text .contract-info-line { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; margin-bottom: 0px; }
        .greeting-contract-number { font-size: 1rem; font-weight: 400; opacity: 0.95; display: inline-flex; align-items: center; gap: 10px; margin: 0;
            color: white; /* Force white color */
             text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4); /* Add shadow for contrast */
        }
        .greeting-contract-number i { opacity: 0.9; margin-right: -3px; }
        .contract-status { font-size: 0.8rem; font-weight: bold; padding: 4px 12px; border-radius: 15px; display: inline-flex; align-items: center; gap: 5px; line-height: 1.3; transition: var(--transition); text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .contract-status.status-active { background-color: rgba(255, 255, 255, 0.3); color: #fff; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 0 8px rgba(255, 255, 255, 0.2); }
        .contract-status.status-closed { background-color: rgba(0, 0, 0, 0.25); color: rgba(255,255,255,0.6); border: 1px solid rgba(0, 0, 0, 0.3); text-shadow: none; }
        .contract-status i { font-size: 0.9em; }
        .user-greeting-bottom { margin-top: 5px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.3); }
        .user-greeting-address { font-size: 0.85rem; color: rgba(255, 255, 255, 0.95); display: flex; align-items: flex-start; gap: 10px; width: 100%; padding: 0; margin: 0 0 15px 0; border: none; }
        .user-greeting-address i { margin-top: 3px; color: rgba(255, 255, 255, 0.9); flex-shrink: 0; font-size: 1rem; }
        .user-greeting-address div { flex: 1; }
        .user-greeting-address strong { color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 3px; font-weight: bold; font-size: 0.75rem; }
        .user-greeting-address span { display: block; line-height: 1.4; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); }
        .greeting-contact-actions { display: flex; gap: 15px; flex-wrap: wrap; padding: 0; margin: 0; border: none; }
        .greeting-contact-actions .contact-btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: var(--transition); text-decoration: none; flex: 1; min-width: 150px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); text-align: center; position: relative; overflow: hidden; }
        .greeting-contact-actions .contact-btn::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.1) 100%); transform: translateX(-100%); transition: transform 0.6s ease; }
        .greeting-contact-actions .contact-btn:hover::after { transform: translateX(100%); }
        .greeting-contact-actions .contact-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); }
        .greeting-contact-actions .contact-btn:active { transform: translateY(0) scale(1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .greeting-contact-actions .call-btn { background-image: linear-gradient(135deg, #1dbf73 0%, #18a063 100%); }
        .greeting-contact-actions .call-btn:hover { background-image: linear-gradient(135deg, #18a063 0%, #1dbf73 100%); }
        .greeting-contact-actions .download-btn { background-image: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); }
        .greeting-contact-actions .download-btn:hover { background-image: linear-gradient(135deg, #3a0ca3 0%, #4361ee 100%); }

        /* Contract Selector... */
        .contract-selector-section { margin-bottom: 15px; }
        .contract-selector-title { font-weight: bold; font-size: 1.1rem; color: var(--text-dark); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .contract-selector-title i { color: var(--primary-color); font-size: 1.2em; }
        .contract-selector-cards { display: flex; gap: 15px; padding: 5px 0 10px 0; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
        .contract-selector-cards::-webkit-scrollbar { display: none; }
        .contract-card-option { background-color: white; border: 2px solid rgba(0, 0, 0, 0.05); border-radius: var(--border-radius); padding: 15px 20px; cursor: pointer; transition: var(--transition); min-width: 240px; flex-shrink: 0; display: flex; flex-direction: column; gap: 4px; box-shadow: var(--card-shadow); position: relative; border-top-width: 5px; padding-top: 12px; }
        .contract-card-option.contract-type-mobile { border-top-color: var(--type-mobile-color); } .contract-card-option.contract-type-refinance { border-top-color: var(--type-refinance-color); } .contract-card-option.contract-type-pawn { border-top-color: var(--type-pawn-color); } .contract-card-option.contract-type-online_pawn { border-top-color: var(--type-online_pawn-color); } .contract-card-option.contract-type-other { border-top-color: var(--type-other-color); }
        .contract-card-option:hover { border-color: var(--secondary-color); border-top-color: var(--secondary-color); background-color: white; transform: translateY(-5px); box-shadow: 0 8px 20px rgba(58, 134, 255, 0.15); }
        .contract-card-option.active { border-color: var(--primary-color); background-color: white; box-shadow: 0 8px 25px rgba(58, 134, 255, 0.2); transform: translateY(0); }
        .contract-card-option.active::before { content: ''; position: absolute; top: -5px; left: 15px; width: calc(100% - 30px); height: 4px; background-color: var(--primary-color); border-radius: 0 0 4px 4px; }
        .card-option-number { font-weight: bold; font-size: 0.95rem; color: var(--text-dark); display: flex; align-items: center; gap: 6px; } .card-option-number i { font-size: 0.9em; color: var(--text-light); }
        .card-option-model { font-size: 0.85rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 0; }
        .card-option-type { font-size: 0.75rem; font-weight: bold; color: var(--text-light); margin-top: 4px; padding: 2px 8px; border-radius: 4px; background-color: rgba(0,0,0,0.03); display: inline-block; align-self: flex-start; }
        .contract-type-mobile .card-option-type { color: var(--type-mobile-color); background-color: rgba(67, 97, 238, 0.1); } .contract-type-refinance .card-option-type { color: var(--type-refinance-color); background-color: rgba(114, 9, 183, 0.1); } .contract-type-pawn .card-option-type { color: var(--type-pawn-color); background-color: rgba(247, 127, 0, 0.1); } .contract-type-online_pawn .card-option-type { color: #a18014; background-color: rgba(255, 158, 0, 0.15); } .contract-type-other .card-option-type { color: var(--type-other-color); background-color: rgba(108, 117, 125, 0.1); }
        .contract-card-option.status-closed { opacity: 0.7; background-color: #f8f9fa; border-top-color: #dee2e6; } .contract-card-option.status-closed:hover { opacity: 0.8; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06); border-color: #dee2e6; border-top-color: #dee2e6; } .contract-card-option.status-closed.active { opacity: 0.9; border-color: #dee2e6; background-color: #f1f3f5; border-top-color: #dee2e6; } .contract-card-option.status-closed .card-option-number, .contract-card-option.status-closed .card-option-model, .contract-card-option.status-closed .card-option-type { color: var(--text-light); }

        /* Data Timestamp... */
        .data-timestamp-container { display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee; font-size: 0.8rem; color: var(--text-light); } #installment-data-timestamp i { margin-right: 4px; } #refresh-data-btn { background: none; border: none; color: var(--primary-color); cursor: pointer; padding: 3px 6px; font-size: 0.9rem; transition: var(--transition); display: flex; align-items: center; border-radius: 4px; } #refresh-data-btn:hover { background-color: rgba(58, 134, 255, 0.1); color: var(--primary-color); } #refresh-data-btn:active { transform: scale(0.95); } #refresh-data-btn.loading i { animation: spin 1s linear infinite; }

        /* Main Content & Cards... */
        .main-content { display: grid; grid-template-columns: 1fr; gap: 25px; margin-top: 0; } @media (min-width: 992px) { .main-content { grid-template-columns: 1fr 1fr; } .tabbed-card { grid-column: 1 / -1; } } @media (min-width: 768px) and (max-width: 991px) { .main-content { grid-template-columns: 1fr; } } .card { background: white; border-radius: var(--border-radius); padding: 25px; box-shadow: var(--card-shadow); transition: var(--transition); position: relative; overflow: hidden; border: 1px solid rgba(0, 0, 0, 0.05); animation: fadeIn 0.5s ease-out forwards; opacity: 0; } .card::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--gradient-primary); } .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(58, 134, 255, 0.1); } .card-title { font-weight: bold; font-size: 1.3rem; margin-bottom: 20px; color: var(--primary-color); display: flex; align-items: center; gap: 8px; } .card-title i { font-size: 1.1em; } .card:nth-child(1) { animation-delay: 0.35s; } .card:nth-child(2) { animation-delay: 0.4s; } .card.tabbed-card { animation-delay: 0.45s; }

        /* Product Info... */
        .product-info .product-image { width: 100%; max-width: 180px; height: auto; display: block; margin: 0 auto 20px auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #eee; transition: var(--transition); } .product-info .product-image:hover { transform: scale(1.03); box-shadow: 0 6px 15px rgba(0,0,0,0.15); } .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 15px; } .info-item { margin-bottom: 0; } .info-label { font-size: 0.85rem; color: var(--text-light); margin-bottom: 3px; display: block; } .info-value { font-weight: bold; font-size: 1rem; display: block; word-break: break-word; }

        /* Payment Card... */
        .payment-card { background: white; border: 1px solid #e0f2f1; position: relative; } .payment-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" fill="none" opacity="0.05"><circle cx="50" cy="50" r="40" stroke="%234361ee" stroke-width="2"/></svg>'); background-size: 100px 100px; opacity: 0.1; z-index: 0; } .payment-card > * { position: relative; z-index: 1; } .payment-card .payment-amount { font-size: 2.8rem; font-weight: bold; color: var(--primary-color); margin: 10px 0 8px 0; text-align: center; position: relative; line-height: 1.2; } .payment-card .payment-due { background-color: transparent; color: var(--text-light); padding: 0; border-radius: 0; font-size: 0.85rem; margin-bottom: 8px; border-left: none; text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px; } .payment-card .payment-due i { color: var(--warning-color); font-size: 1em; } .payment-card .payment-due strong { color: var(--text-dark); font-weight: bold; } #payment-countdown { font-size: 0.9rem; font-weight: bold; text-align: center; margin-bottom: 15px; color: var(--danger-color); min-height: 1.4em; } #payment-countdown i { margin-right: 5px; } #payment-countdown.past-due { color: var(--danger-color); font-weight: bold; } #payment-countdown.completed { color: var(--success-color); } .payment-card .additional-payment-info { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #e0e8f0; margin-bottom: 15px; } .payment-card .additional-info-item { display: flex; justify-content: space-between; margin-bottom: 8px; line-height: 1.4; align-items: baseline; } .payment-card .additional-info-label { color: var(--text-light); font-size: 0.85rem; margin-right: 10px; flex-shrink: 0; } .payment-card .additional-info-value { font-weight: bold; font-size: 0.9rem; color: var(--text-dark); text-align: right; word-break: break-all; }
        /* Style late fee amount */
        .payment-card #late-fee { color: var(--danger-color); transition: color 0.3s ease; }
        .payment-card .discount-line span:first-child { color: var(--success-color); } .payment-card .discount-line span:last-child { color: var(--success-color); font-weight: bold; }
         .payment-card .original-price .additional-info-value { text-decoration: line-through; color: var(--text-light); font-weight: normal; } /* Style for strike-through */
        .payment-card #discounted-close-amount { color: var(--accent-color); font-weight: bold; font-size: 1.1rem; } /* Made closing amount more prominent */
        .payment-card #bill-id { color: var(--info-color); font-size: 0.95rem; }
        .payment-card .final-payment { background-color: #eef9ff; padding: 12px 18px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #bde0fe; border-left: 5px solid var(--success-color); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); } .payment-card .final-payment-label { font-weight: bold; font-size: 0.95rem; color: var(--text-dark); } .payment-card .final-payment-value { font-weight: bold; color: var(--success-color); font-size: 1.3em; }
        .payment-buttons-container { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .payment-card .payment-button { background: var(--gradient-primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: bold; flex: 1; min-width: 120px; cursor: pointer; transition: var(--transition); position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(58, 134, 255, 0.3); display: inline-flex; align-items: center; justify-content: center; gap: 8px; margin-top: 0; } .payment-card .payment-button::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.1) 100%); transform: translateX(-100%); transition: transform 0.6s ease; } .payment-card .payment-button:hover::after { transform: translateX(100%); } .payment-card .payment-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(58, 134, 255, 0.4); } .payment-card .payment-button:active { transform: translateY(1px); } .payment-card .close-loan-button { background: var(--accent-color); box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3); } .payment-card .close-loan-button:hover { background: #f50076; box-shadow: 0 8px 25px rgba(247, 37, 133, 0.4); } .payment-card .postpone-payment-button { background: var(--warning-color); box-shadow: 0 5px 15px rgba(255, 190, 11, 0.3); } .payment-card .postpone-payment-button:hover { background: #ffaa00; box-shadow: 0 8px 25px rgba(255, 190, 11, 0.4); }

        /* Style for disabled state with double-click prevention */
        .payment-card .payment-button:disabled,
        .payment-card .close-loan-button:disabled,
        .payment-card .postpone-payment-button:disabled,
        .pay-early-btn:disabled, /* Add pay-early button */
        .unlock-btn:disabled /* Add unlock button */
         {
            opacity: 0.6 !important; /* Ensure opacity is applied */
            cursor: not-allowed !important;
            background: #adb5bd !important; /* Override gradients/colors */
            background-image: none !important;
            box-shadow: none !important;
            transform: none !important; /* Prevent hover/active transforms */
            border-color: transparent !important;
        }
        /* Ensure hover/active styles are also overridden when disabled */
        .payment-card .payment-button:disabled:hover,
        .payment-card .close-loan-button:disabled:hover,
        .payment-card .postpone-payment-button:disabled:hover,
        .pay-early-btn:disabled:hover,
        .unlock-btn:disabled:hover,
        .payment-card .payment-button:disabled:active,
        .payment-card .close-loan-button:disabled:active,
        .payment-card .postpone-payment-button:disabled:active,
        .pay-early-btn:disabled:active,
        .unlock-btn:disabled:active
        {
            background: #adb5bd !important;
            background-image: none !important;
            box-shadow: none !important;
            transform: none !important;
        }
        /* Hide shimmer effect when disabled */
        .payment-card .payment-button:disabled::after,
        .payment-card .close-loan-button:disabled::after,
        .payment-card .postpone-payment-button:disabled::after,
        .unlock-btn:disabled::after {
             display: none;
        }

        /* Unlock Options Styling */
        .unlock-options {
            background-color: #fff8f8;
            border: 1px solid #fdd;
            border-left: 5px solid var(--danger-color);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(239, 35, 60, 0.1);
            margin-top: 20px; /* Added margin top */
        }
        .unlock-options h4 {
            font-weight: bold;
            font-size: 0.95rem;
            color: var(--danger-color);
            margin-bottom: 10px;
        }
         .unlock-options h4 i { margin-right: 5px; }
         .unlock-options p {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 12px;
         }
        .unlock-options .payment-buttons-container {
            margin-top: 10px; /* Reduced margin */
            gap: 8px; /* Reduced gap */
        }
        .unlock-options .unlock-btn {
            font-size: 0.85rem;
            padding: 10px 15px;
            color: white; /* Ensure text is white */
            border: none; /* Remove border */
        }
        .unlock-options .unlock-btn i {
            font-size: 1em; /* Make icon slightly larger relative to text */
        }
        .unlock-options .unlock-btn[data-type="standard"] {
            background: var(--info-color);
            box-shadow: 0 4px 12px rgba(72, 149, 239, 0.25);
        }
        .unlock-options .unlock-btn[data-type="standard"]:hover:not(:disabled) {
            background: #3a86ff;
             box-shadow: 0 6px 15px rgba(72, 149, 239, 0.35);
        }
         .unlock-options .unlock-btn[data-type="express"] {
            background: var(--accent-color);
            box-shadow: 0 4px 12px rgba(247, 37, 133, 0.25);
        }
        .unlock-options .unlock-btn[data-type="express"]:hover:not(:disabled) {
            background: #f50076;
            box-shadow: 0 6px 15px rgba(247, 37, 133, 0.35);
        }


        /* Tabs... */
        .tab-nav { display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 25px; gap: 5px; } .tab-link { padding: 12px 20px; cursor: pointer; border: none; background-color: #f1f3f5; color: var(--text-light); font-weight: bold; font-size: 1rem; border-radius: 8px 8px 0 0; transition: var(--transition); border-bottom: 3px solid transparent; display: flex; align-items: center; gap: 8px; } .tab-link:hover { background-color: #e9ecef; color: var(--text-dark); } .tab-link.active { background-color: white; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); } .tab-content { display: none; animation: fadeInTab 0.5s ease-out; } @keyframes fadeInTab { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } .tab-content.active { display: block; }

        /* Installment Info Tab... */
        .tab-content#installment-info-tab .progress-container { margin-top: 20px; margin-bottom: 20px; } .tab-content#installment-info-tab .progress-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; } .tab-content#installment-info-tab .progress-bar { height: 8px; background-color: #e0e8f0; border-radius: 4px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.08); } .tab-content#installment-info-tab .progress-fill { height: 100%; background: var(--gradient-primary); border-radius: 4px; width: 0; transition: width 1s ease-out; position: relative; overflow: hidden; } .tab-content#installment-info-tab .progress-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0.1) 100%); animation: shimmer-progress 2s infinite linear; } @keyframes shimmer-progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } } .tab-content#installment-info-tab .payment-schedule-table-container h3 { margin-top: 20px; margin-bottom: 10px; font-size: 1.05rem; color: var(--text-dark); } .payment-schedule-table-container { overflow-x: auto; } .payment-schedule-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; } .payment-schedule-table th, .payment-schedule-table td { border: 1px solid #e0e8f0; padding: 10px 12px; text-align: left; vertical-align: middle; } .payment-schedule-table th { background-color: #f8f9fa; font-weight: bold; color: var(--text-dark); white-space: nowrap; } .payment-schedule-table td { color: var(--text-dark); } .payment-schedule-table tbody tr:nth-child(even) { background-color: #fdfdff; } .payment-schedule-table .status-icon { margin-right: 5px; font-size: 0.9em; vertical-align: middle; } .payment-schedule-table .status-tag { display: inline-flex; align-items: center; font-weight: bold; white-space: nowrap; padding: 3px 8px; border-radius: 15px; font-size: 0.8rem; } .payment-schedule-table .status-paid { color: var(--success-color); background-color: rgba(74, 214, 109, 0.1); } .payment-schedule-table .status-due-now { color: var(--primary-color); background-color: rgba(58, 134, 255, 0.1); } .payment-schedule-table .status-upcoming { color: var(--info-color); background-color: rgba(72, 149, 239, 0.1); } .payment-schedule-table .status-past-due { color: var(--danger-color); background-color: rgba(239, 35, 60, 0.1); }
        .payment-schedule-table .paid-date { font-size: 0.8rem; color: var(--text-light); white-space: nowrap; display: block; } .payment-schedule-table .bill-id-display { font-size: 0.8rem; color: var(--text-light); display: block; margin-top: 3px; white-space: nowrap; }
        .payment-schedule-table .next-due-row { background-color: #fff3cd !important; font-weight: bold; border-left: 4px solid var(--warning-color); } .payment-schedule-table .past-due-row { background-color: #ffebee !important; border-left: 4px solid var(--danger-color); }
        .payment-schedule-table td:nth-child(3) { text-align: right; font-weight: bold; } /* Amount */
        .payment-schedule-table td:nth-child(4) { vertical-align: middle; text-align: center; } /* Status */
        .payment-schedule-table td:nth-child(5) { vertical-align: middle; text-align: left; } /* Details (Paid Date, Bill ID) */
        .payment-schedule-table td:nth-child(6) { vertical-align: middle; text-align: center; } /* Actions */

        /* Style for Pay Early Button - ENHANCED */
        .pay-early-btn {
            background-color: #e0f2fe; /* Slightly different blue */
            color: var(--primary-color);
            border: 1px solid #bae6fd; /* Matching border */
            padding: 6px 14px; /* Slightly more padding */
            border-radius: 6px;
            font-size: 0.85rem; /* Slightly larger font */
            cursor: pointer;
            transition: var(--transition);
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 6px; /* More gap */
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(58, 134, 255, 0.1); /* Subtle shadow */
            line-height: 1.4; /* Ensure decent height */
        }
        .pay-early-btn i {
            font-size: 1em; /* Slightly larger icon */
            margin-right: -2px; /* Adjust icon spacing */
        }
        .pay-early-btn:hover:not(:disabled) {
            background-color: #bfdffd;
            border-color: #7dd3fc;
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 3px 6px rgba(58, 134, 255, 0.15);
        }
        .pay-early-btn:active:not(:disabled) {
             transform: translateY(0) scale(1);
             box-shadow: 0 1px 3px rgba(58, 134, 255, 0.1);
        }

        /* History Tab - Enhanced Styling for Payment Types */
        .payment-history-container { display: flex; flex-direction: column; gap: 12px; }
        .payment-item { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); border: 1px solid rgba(0, 0, 0, 0.05); transition: var(--transition); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px 15px; }
        .payment-item.payment-item-paid { background-color: #f8f9fa; border-color: #dee2e6; border-left: 4px solid var(--success-color); }
        .payment-item.payment-item-paid .payment-item-icon { color: var(--success-color); }
        .payment-item.payment-item-paid:hover { border-color: var(--success-color); }

        .payment-item.payment-item-fee { background-color: #fffef0; }
        .payment-item.payment-item-fee .payment-item-actions { display: none; } /* Hide actions for fee items */

        .payment-item.payment-item-fee.fee-type-late { border-left: 4px solid var(--danger-color); }
        .payment-item.payment-item-fee.fee-type-late .payment-item-icon { color: var(--danger-color); }
        .payment-item.payment-item-fee.fee-type-late .payment-period { color: var(--danger-color); }
        .payment-item.payment-item-fee.fee-type-late .payment-amount-small { color: var(--danger-color); font-weight: bold; }
        .payment-item.payment-item-fee.fee-type-late .payment-status { color: var(--danger-color); background-color: rgba(239, 35, 60, 0.1); }
        .payment-item.payment-item-fee.fee-type-late:hover { border-color: var(--danger-color); }

        .payment-item.payment-item-fee.fee-type-postpone { border-left: 4px solid var(--warning-color); }
        .payment-item.payment-item-fee.fee-type-postpone .payment-item-icon { color: var(--warning-color); }
        .payment-item.payment-item-fee.fee-type-postpone .payment-period { color: #c66900; }
        .payment-item.payment-item-fee.fee-type-postpone .payment-amount-small { color: var(--warning-color); font-weight: bold; }
        .payment-item.payment-item-fee.fee-type-postpone .payment-status { color: #c66900; background-color: rgba(255, 190, 11, 0.1); }
        .payment-item.payment-item-fee.fee-type-postpone:hover { border-color: var(--warning-color); }

         /* NEW: Unlock Fee in History */
        .payment-item.payment-item-fee.fee-type-unlock { border-left: 4px solid var(--info-color); }
        .payment-item.payment-item-fee.fee-type-unlock .payment-item-icon { color: var(--info-color); }
        .payment-item.payment-item-fee.fee-type-unlock .payment-period { color: var(--info-color); }
        .payment-item.payment-item-fee.fee-type-unlock .payment-amount-small { color: var(--info-color); font-weight: bold; }
        .payment-item.payment-item-fee.fee-type-unlock .payment-status { color: var(--info-color); background-color: rgba(72, 149, 239, 0.1); }
        .payment-item.payment-item-fee.fee-type-unlock:hover { border-color: var(--info-color); }


        .payment-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(58, 134, 255, 0.08); }
        .payment-item-main { display: flex; align-items: center; gap: 12px; flex-grow: 1; min-width: 150px; }
        .payment-item-icon { font-size: 1.4rem; flex-shrink: 0; width: 25px; text-align: center; }
        .payment-item-info { display: flex; flex-direction: column; }
        .payment-period { font-weight: bold; color: var(--text-dark); font-size: 0.95rem; }
        .payment-date { color: var(--text-light); font-size: 0.8rem; }
        .payment-item-details { display: flex; align-items: center; gap: 15px; flex-grow: 1; justify-content: flex-end; min-width: 180px; flex-wrap: nowrap; }
        .payment-amount-small { font-weight: bold; color: var(--text-dark); font-size: 0.95rem; text-align: right; white-space: nowrap; }
        .payment-status { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; white-space: nowrap; }
        .payment-status .status-icon { font-size: 1em; margin-right: 2px; }
        .payment-item.payment-item-paid .status-paid { color: var(--success-color); background-color: rgba(74, 214, 109, 0.15); }
        .payment-item.payment-item-paid .status-paid .status-icon { color: var(--success-color); }

        .payment-item-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .view-slip-btn, .receipt-btn { border: 1px solid transparent; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: var(--transition); font-weight: bold; display: inline-flex; align-items: center; gap: 5px; white-space: nowrap; }
        .view-slip-btn i, .receipt-btn i { font-size: 0.9em; }
        .view-slip-btn { background-color: #e7f5ff; color: var(--primary-color); border-color: #cdeaff; }
        .view-slip-btn:hover { background-color: #d0eaff; border-color: #addfff; transform: translateY(-1px); }
        .receipt-btn { background-color: #e6fcf5; color: #0ca678; border-color: #c3fae8; }
        .receipt-btn:hover { background-color: #b6f2dd; border-color: #96e9c7; transform: translateY(-1px); }
        .show-more-btn { background: var(--secondary-color); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: var(--transition); margin: 20px auto 0; display: inline-flex; align-items: center; gap: 8px; width: fit-content; box-shadow: 0 3px 10px rgba(76, 201, 240, 0.3); }
        .show-more-btn i { transition: transform 0.3s ease; }
        .show-more-btn.expanded i { transform: rotate(180deg); }
        .show-more-btn:hover { background: #3abfd9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 201, 240, 0.4); }
        .hidden-payment { animation: fadeInPayment 0.5s ease-out forwards; opacity: 0; display: none; } /* Added display none */
        @keyframes fadeInPayment { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }


        /* Modals... */
        .slip-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10001; align-items: center; justify-content: center; padding: 20px; } .slip-modal-content { background: white; border-radius: var(--border-radius); width: 90%; max-width: 500px; padding: 25px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: modalFadeIn 0.3s ease-out; } @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } } .close-modal { position: absolute; top: 15px; right: 15px; font-size: 1.8rem; color: var(--text-light); cursor: pointer; transition: var(--transition); line-height: 1; } .close-modal:hover { color: var(--danger-color); transform: rotate(90deg); } .slip-image { width: 100%; max-height: 60vh; object-fit: contain; border-radius: 10px; margin-top: 15px; border: 1px solid #eee; box-shadow: 0 3px 10px rgba(0,0,0,0.1); } .modal-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); margin-bottom: 5px; } .modal-subtitle { font-size: 0.9rem; color: var(--text-light); margin-bottom: 15px; } .receipt-details-container { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; } .receipt-detail-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; align-items: center; } .receipt-detail-item span:first-child { color: var(--text-light); } .receipt-detail-item span:last-child { font-weight: bold; color: var(--text-dark); } .receipt-detail-item .payment-status { font-weight: bold; background-color: transparent; padding: 0; border: none; border-radius: 0; font-size: inherit; } .download-pdf-btn { margin-top: 15px; padding: 10px 20px; font-size: 0.95rem; width: 100%; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px; } .download-pdf-btn:hover { background: #2a75e6; transform: translateY(-2px); }

        /* FAB Button & Menu... */
        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 100; display: none; } .fab { width: 60px; height: 60px; background: var(--gradient-primary); color: white; border-radius: 50%; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 10px 25px rgba(58, 134, 255, 0.4); cursor: pointer; transition: var(--transition); position: relative; z-index: 101; display: none; } .fab:hover { transform: scale(1.1) rotate(15deg); box-shadow: 0 15px 30px rgba(58, 134, 255, 0.5); } .fab-menu { position: absolute; bottom: 75px; right: 0; background-color: white; border-radius: var(--border-radius); box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 10px; display: flex; flex-direction: column; gap: 8px; opacity: 0; visibility: hidden; transform: translateY(10px) scale(0.95); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100; min-width: 180px; border: 1px solid rgba(0,0,0,0.08); } .fab-menu.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); } .fab-menu-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; text-decoration: none; color: var(--text-dark); border-radius: 6px; transition: background-color 0.2s ease; font-size: 0.9rem; } .fab-menu-item:hover { background-color: #f1f3f5; color: var(--primary-color); } .fab-menu-item i { width: 20px; text-align: center; color: var(--primary-color); font-size: 1.1em; } .fab-menu-item .fab-line-icon { color: #06C755; } .fab-menu-item .fab-email-icon { color: #ea4335; } .fab-menu-item .fab-phone-icon { color: #1dbf73; }

        /* Bottom Nav... */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: white; border-top: 1px solid rgba(0, 0, 0, 0.1); box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08); z-index: 1000; padding: 5px 0; } .bottom-nav-items { display: flex; justify-content: space-around; align-items: center; width: 100%; } .bottom-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: var(--text-light); font-size: 0.7rem; padding: 5px 10px; flex: 1; text-align: center; transition: var(--transition); gap: 3px; } .bottom-nav-item i { font-size: 1.4rem; margin-bottom: 2px; transition: var(--transition); } .bottom-nav-item.active { color: var(--primary-color); font-weight: bold; } .bottom-nav-item.active i { transform: translateY(-5px); } .bottom-nav-item:hover { color: var(--primary-color); }

        /* --- Responsive Adjustments --- */
        @media (min-width: 768px) { body.content-visible .bottom-nav { display: none; } body.content-visible .main-app-content { padding-bottom: 20px; } .fab-container { bottom: 30px; right: 30px; } .fab-menu { bottom: 75px; } }
        @media (max-width: 768px) {
            body.content-visible .main-app-content { padding-bottom: 65px; }
            .payment-schedule-table thead { display: none; }
            .payment-schedule-table tr { display: block; margin-bottom: 12px; border: 1px solid #e0e8f0; border-radius: 8px; padding: 12px 15px; background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
            .payment-schedule-table tr.next-due-row { background-color: #fff9e6 !important; border-left: 4px solid var(--warning-color); padding-left: 12px; }
            .payment-schedule-table tr.past-due-row { background-color: #ffebee !important; border-left: 4px solid var(--danger-color); padding-left: 12px; }
            .payment-schedule-table td {
                display: flex; /* Use flexbox for layout */
                justify-content: space-between; /* Push label left, content right */
                align-items: center; /* Align items vertically */
                text-align: right; /* Align text content to right by default */
                padding: 8px 0;
                border: none;
                border-bottom: 1px dashed #eee;
                font-size: 0.9rem;
                min-height: 1.6em;
                flex-wrap: wrap; /* Allow wrapping if needed */
                width: 100%; /* Ensure TD takes full width */
            }
            .payment-schedule-table td:last-child { border-bottom: none; }
            .payment-schedule-table td::before {
                content: attr(data-label);
                font-weight: bold;
                color: var(--text-light);
                margin-right: 10px;
                font-size: 0.75rem;
                text-transform: uppercase;
                text-align: left; /* Ensure label text is left-aligned */
                flex-shrink: 0; /* Prevent label from shrinking */
                line-height: 1.6;
                padding-right: 5px;
            }
            /* Ensure content inside td takes remaining space and aligns right */
            .payment-schedule-table td > span,
            .payment-schedule-table td > div,
            .payment-schedule-table td > button {
                margin-left: auto; /* Push content to the right */
                text-align: right; /* Align text within the content span/div/button right */
                flex-grow: 1; /* Allow content to take up remaining space */
                word-break: break-word; /* Allow long content to wrap */
            }
            /* Specific adjustments for mobile table (Status and Actions pushed right) */
            .payment-schedule-table td[data-label="รายละเอียด"] > div { text-align: right; } /* Ensure details div aligns right */
            .payment-schedule-table td[data-label="รายละเอียด"] .paid-date,
            .payment-schedule-table td[data-label="รายละเอียด"] .bill-id-display {
                font-size: 0.8rem;
                text-align: right; /* Ensure nested spans align right */
                display: block; /* Make sure they stack if needed */
                width: 100%; /* Take full width of the right side */
            }
            .payment-schedule-table td[data-label="สถานะ"] > span { /* Target the status tag */
                 font-size: 0.8rem;
                 justify-self: flex-end; /* Explicitly align status tag to the end */
                 margin-left: auto; /* Re-affirm margin-left auto */
            }
            .payment-schedule-table td[data-label="การดำเนินการ"] > button { /* Target the action button */
                font-size: 0.85rem; /* Slightly larger on mobile table */
                padding: 5px 10px; /* Adjusted padding */
                margin-left: auto; /* Ensure button aligns right */
                width: auto; /* Let button size itself */
                flex-grow: 0; /* Don't force grow */
                flex-shrink: 0;
            }
            .payment-schedule-table td[data-label="จำนวนเงิน (บาท)"] > span { font-weight: bold; }
        }
        @media (max-width: 767px) {
            .pin-overlay { padding: 0; } .pin-container { width: 100%; max-width: none; height: 100%; border-radius: 0; box-shadow: none; display: flex; flex-direction: column; justify-content: center; } .keypad button { width: 70px; height: 70px; font-size: 1.8rem; } .keypad { gap: 20px; margin-top: 30px; }
            body.content-visible .main-app-content { padding-top: 55px; } body.content-visible .container { padding: 15px; } .card { padding: 20px; } .fab-container { bottom: 80px; right: 20px; } .fab { width: 55px; height: 55px; font-size: 1.4rem; } .fab-menu { bottom: 70px; }
            .app-header { padding: 0 10px; height: 55px; } .app-logo { height: 25px; } .app-avatar { width: 35px; height: 35px; } .app-header-right { gap: 12px; } .app-header .notification-bell { font-size: 1.3rem; } .app-close-button { font-size: 1.4rem; padding: 6px; }
            .contract-selector-cards { gap: 10px; } .contract-card-option { min-width: 200px; padding: 12px 15px; border-top-width: 4px; } .card-option-number { font-size: 0.9rem; } .card-option-model { font-size: 0.8rem; } .card-option-type { font-size: 0.7rem; padding: 1px 5px; margin-top: 2px; }
            .user-greeting { padding: 20px 15px; }
            .greeting-avatar { width: 65px; height: 65px; }
            .greeting-text .user-name { font-size: 1.6rem; } .greeting-text p { font-size: 0.85rem; } .greeting-contract-number { font-size: 0.9rem; }
            .user-greeting-bottom {
                margin-top: 8px; /* Reduced spacing */
                padding-top: 8px;
            }
            .user-greeting-address {
                 font-size: 0.8rem;
                 margin-bottom: 10px; /* Reduced spacing */
            }
             .user-greeting-address span { text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); } /* Add shadow on mobile too */

            .greeting-contact-actions .contact-btn {
                font-size: 0.8rem;
                padding: 8px 15px;
                min-width: auto; /* Rely on flex */
            }
            .product-info .info-grid, .tab-content#installment-info-tab .info-grid { grid-template-columns: 1fr 1fr; gap: 8px 10px; } .info-label { font-size: 0.8rem; } .info-value { font-size: 0.95rem; } .product-info .product-image { max-width: 120px; margin-bottom: 15px; } .tab-content#installment-info-tab .progress-info { font-size: 0.85rem; } .data-timestamp-container { font-size: 0.75rem; gap: 5px; } #refresh-data-btn { font-size: 0.85rem; padding: 2px 4px; }
            .payment-card { padding: 15px; } .payment-card .card-title { font-size: 1.1rem; margin-bottom: 15px; } .payment-card .payment-amount { font-size: 2.2rem; margin: 5px 0 5px 0; } .payment-card .payment-due { font-size: 0.8rem; margin-bottom: 5px; gap: 4px; flex-wrap: wrap; justify-content: center; } #payment-countdown { font-size: 0.85rem; margin-bottom: 12px; } .payment-card .additional-payment-info { padding-top: 12px; margin-bottom: 12px; } .payment-card .additional-info-item { margin-bottom: 6px; } .payment-card .additional-info-label { font-size: 0.8rem; } .payment-card .additional-info-value { font-size: 0.85rem; } .payment-card #discounted-close-amount { font-size: 1rem; } /* Adjust close amount size */
            .payment-card .final-payment { padding: 10px 15px; flex-direction: row; align-items: center; justify-content: space-between; gap: 10px; } .payment-card .final-payment-label { font-size: 0.85rem; } .payment-card .final-payment-value { font-size: 1.2em; text-align: right; }
            .payment-buttons-container { gap: 8px; } .payment-card .payment-button, .payment-card .close-loan-button, .payment-card .postpone-payment-button { font-size: 0.8rem; padding: 8px 10px; min-width: 80px; flex-grow: 1; gap: 5px; } .payment-card .payment-button i, .payment-card .close-loan-button i, .payment-card .postpone-payment-button i { font-size: 0.9em; }
             /* Unlock buttons on mobile */
             .unlock-options { padding: 12px 15px; } /* Slightly more padding */
             .unlock-options .unlock-btn { font-size: 0.75rem; padding: 8px 10px; }
             .unlock-options h4 { font-size: 0.9rem; }
             .unlock-options p { font-size: 0.8rem; }

            .payment-item { flex-direction: column; align-items: stretch; padding: 12px; }
            .payment-item-main { min-width: 0; gap: 10px; }
            .payment-item-icon { font-size: 1.3rem; width: 20px; }
            .payment-period { font-size: 0.9rem; }
            .payment-date { font-size: 0.75rem; }
            .payment-item-details { justify-content: space-between; width: 100%; min-width: 0; gap: 10px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #eee; }
            .payment-amount-small { font-size: 0.9rem; text-align: left; }
            .payment-status { font-size: 0.7rem; padding: 3px 8px; }
            .payment-item-actions { margin-top: 10px; width: 100%; justify-content: flex-start; gap: 8px; }
            .view-slip-btn, .receipt-btn { font-size: 0.75rem; padding: 5px 10px; }
            .payment-item.payment-item-fee .payment-item-actions { display: none; } /* Still hide fee actions */
            .hidden-payment { display: none; /* Ensure hidden payments are truly hidden */ }

            .app-header .notification-panel { width: calc(100vw - 30px); max-width: 320px; right: -10px; }
        }
        @media (max-width: 480px) {
            .keypad button { width: 60px; height: 60px; font-size: 1.5rem; } .keypad { gap: 15px; }
            body.content-visible .main-app-content { padding-top: 50px; padding-bottom: 60px; } body.content-visible .container { padding: 10px; } .card { padding: 15px; } .fab-container { bottom: 75px; right: 15px; } .fab { width: 50px; height: 50px; font-size: 1.3rem; } .fab-menu { bottom: 65px; }
            .app-header { height: 50px; padding: 0 8px; } .app-logo { height: 20px; } .app-avatar { width: 30px; height: 30px; } .app-header-right { gap: 8px; } .app-header .notification-bell { font-size: 1.1rem; } .app-close-button { font-size: 1.2rem; padding: 5px; }
            .contract-card-option { min-width: 170px; padding: 10px 12px; } .card-option-number { font-size: 0.8rem; } .card-option-model { font-size: 0.7rem; } .card-option-type { font-size: 0.65rem; }
            .user-greeting { padding: 15px 12px; }
            .greeting-avatar { width: 55px; height: 55px; }
            .greeting-text { margin-bottom: 8px; }
            .greeting-time { font-size: 0.9rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4); }
             #greeting-icon { filter: drop-shadow(0 1px 1px rgba(0,0,0,0.5)); }
            .greeting-text .user-name { font-size: 1.4rem; text-shadow: 0 1px 3px rgba(0,0,0,0.4); }
            .greeting-text p { font-size: 0.8rem; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); }
            .greeting-contract-number { font-size: 0.8rem; gap: 6px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); } .contract-status { font-size: 0.7rem; padding: 2px 8px; }
            .user-greeting-bottom {
                margin-top: 8px; /* Reduced spacing */
                padding-top: 8px;
            }
            .user-greeting-address {
                font-size: 0.75rem;
                margin-bottom: 8px; /* Reduced spacing */
             }
            .greeting-contact-actions .contact-btn {
                min-width: auto; /* Rely on flex */
                font-size: 0.75rem;
                padding: 6px 10px;
                flex: 1; /* Ensure it takes available space */
            }
            .product-info .info-grid, .tab-content#installment-info-tab .info-grid { grid-template-columns: 1fr 1fr; gap: 5px 8px; } .info-label { font-size: 0.75rem; margin-bottom: 2px; } .info-value { font-size: 0.85rem; } .product-info .product-image { max-width: 90px; margin-bottom: 10px; } .tab-content#installment-info-tab .progress-info { font-size: 0.8rem; } .tab-content#installment-info-tab .payment-schedule-table-container h3 { font-size: 1rem; } .data-timestamp-container { font-size: 0.7rem; padding-top: 8px; } #refresh-data-btn { font-size: 0.8rem; }
            .payment-card { padding: 12px; } .payment-card .card-title { font-size: 1rem; } .payment-card .payment-amount { font-size: 2rem; } .payment-card .payment-due { font-size: 0.75rem; } #payment-countdown { font-size: 0.8rem; } .payment-card .additional-info-label { font-size: 0.75rem; flex-basis: 55%; } .payment-card .additional-info-value { font-size: 0.8rem; flex-basis: 45%; } .payment-card #discounted-close-amount { font-size: 0.9rem; } /* Adjust close amount size */
            .payment-card .final-payment-label { font-size: 0.8rem; } .payment-card .final-payment-value { font-size: 1.2em; }
            .payment-buttons-container {
                flex-direction: row;
                gap: 6px;
            }
            .payment-card .payment-button, .payment-card .close-loan-button, .payment-card .postpone-payment-button {
                font-size: 0.75rem;
                padding: 8px 5px;
                min-width: auto;
                width: auto;
                flex: 1;
                text-align: center;
                gap: 4px;
            }
             .payment-card .payment-button i, .payment-card .close-loan-button i, .payment-card .postpone-payment-button i {
                 font-size: 0.8em;
             }
            /* Unlock buttons on smallest screens */
            .unlock-options { padding: 10px 15px; }
            .unlock-options .payment-buttons-container { flex-direction: column; } /* Stack buttons vertically */
            .unlock-options .unlock-btn { width: 100%; font-size: 0.75rem; padding: 8px 5px; }

            .payment-schedule-table tr { padding: 10px 12px; margin-bottom: 10px; }
            .payment-schedule-table td { font-size: 0.8rem; padding: 5px 0; }
            .payment-schedule-table td::before { font-size: 0.7rem; }
            /* Mobile table details adjustments */
             .payment-schedule-table td[data-label="รายละเอียด"] .paid-date,
             .payment-schedule-table td[data-label="รายละเอียด"] .bill-id-display { font-size: 0.75rem; }
             .payment-schedule-table td[data-label="สถานะ"] > span { font-size: 0.7rem; padding: 2px 6px; }
             .payment-schedule-table td[data-label="การดำเนินการ"] > button {
                 font-size: 0.8rem; /* Keep slightly larger */
                 padding: 4px 8px; /* Adjusted padding */
                 width: 100%; /* Make button full width in its cell */
                 justify-content: center; /* Center content */
             }

            .payment-item { padding: 10px; } .payment-item-main { gap: 8px; } .payment-item-icon { font-size: 1.2rem; } .payment-period { font-size: 0.85rem; } .payment-date { font-size: 0.7rem; } .payment-amount-small { font-size: 0.85rem; } .payment-item-actions { gap: 6px; } .view-slip-btn, .receipt-btn { font-size: 0.7rem; padding: 4px 8px; gap: 4px; }
            .app-header .notification-panel { width: calc(100vw - 20px); max-width: 300px; right: -5px; } .notification-tab-btn { font-size: 0.7rem; padding: 4px 6px; } .notification-item { padding: 6px 10px; gap: 8px; } .notification-item-text { font-size: 0.75rem; } .notification-item-time { font-size: 0.65rem; }
            .bottom-nav-item i { font-size: 1.2rem; } .bottom-nav-item { font-size: 0.65rem; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shimmer { 0% { transform: rotate(-30deg) translateX(-150%); } 100% { transform: rotate(-30deg) translateX(150%); } }

    </style>
</head>
<body>

    <div class="pin-overlay" id="pin-overlay">
        <div class="pin-container">
            <h2 class="pin-title">กรุณาป้อนรหัส PIN</h2>
            <p class="pin-instructions">กรุณาป้อนรหัส PIN 6 หลักเพื่อเข้าใช้งานระบบ</p>
            <div class="pin-status-message" id="pin-status-message"></div>
            <div class="pin-display" id="pin-display">
                <span class="pin-dot"></span>
                <span class="pin-dot"></span>
                <span class="pin-dot"></span>
                <span class="pin-dot"></span>
                <span class="pin-dot"></span>
                <span class="pin-dot"></span>
            </div>
            <div class="pin-error" id="pin-error"></div>
            <div class="keypad" id="keypad">
                <button data-key="1">1</button> <button data-key="2">2</button> <button data-key="3">3</button>
                <button data-key="4">4</button> <button data-key="5">5</button> <button data-key="6">6</button>
                <button data-key="7">7</button> <button data-key="8">8</button> <button data-key="9">9</button>
                <button class="key-clear" data-key="clear"><i class="fas fa-times"></i></button>
                <button data-key="0">0</button>
                <button class="key-backspace" data-key="backspace"><i class="fas fa-backspace"></i></button>
            </div>
        </div>
    </div>

    <div class="main-app-content">
        <div class="loading-overlay" id="loading-overlay"> <div class="spinner"></div> </div>
        <header class="app-header"> <div class="app-header-left"> <img src="https://via.placeholder.com/40" alt="User Avatar" class="app-avatar" id="app-avatar"> </div> <div class="app-header-center"> <img src="https://lh3.googleusercontent.com/d/1Aoj_LFAtjUjfilbWpOq7Jx-IRPJ11XZT" alt="Your Logo" class="app-logo" id="app-logo"> </div> <div class="app-header-right"> <div class="notification-wrapper" id="notification-wrapper"> <div class="notification-bell" id="notification-bell-icon" title="การแจ้งเตือน"> <i class="fas fa-bell"></i> <span class="notification-badge hidden" id="notification-count">0</span> </div> <div class="notification-panel" id="notification-panel"> <div class="notification-header"> <div class="notification-tabs"> <button class="notification-tab-btn active" data-tab-target="app-status">สถานะ</button> <button class="notification-tab-btn" data-tab-target="app-promo">โปรโมชั่น</button> </div> <div class="notification-title-bar"> <span>การแจ้งเตือน</span> <button class="notification-clear-btn" id="clear-all-notifications">ล้างทั้งหมด</button> </div> </div> <div class="notification-list-container"> <ul class="notification-list active" id="notification-list-status" data-type="app-status"></ul> <ul class="notification-list" id="notification-list-promo" data-type="app-promo"></ul> </div> </div> </div> <button class="app-close-button" id="app-close-button" title="ปิด"> <i class="fas fa-times"></i> </button> </div> </header>
        <div class="slip-modal" id="slip-modal"> <div class="slip-modal-content"> <span class="close-modal" onclick="closeModal('slip-modal')">×</span> <h3 class="modal-title">หลักฐานการชำระเงิน</h3> <p class="modal-subtitle" id="slip-details">...</p> <img src="" alt="สลิปโอนเงิน" class="slip-image" id="slip-image-placeholder"> <div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-light); text-align: center;">กรุณาตรวจสอบความถูกต้องของรายละเอียด</div> </div> </div>
        <div class="slip-modal" id="receipt-modal"> <div class="slip-modal-content"> <span class="close-modal" onclick="closeModal('receipt-modal')">×</span> <h3 class="modal-title">ใบเสร็จรับเงิน / ใบกำกับภาษี</h3> <p class="modal-subtitle" id="receipt-details">...</p> <div class="receipt-details-container"> <div class="receipt-detail-item"><span>เลขที่เอกสาร:</span><span id="receipt-doc-no">...</span></div> <div class="receipt-detail-item"><span>วันที่ออกเอกสาร:</span><span id="receipt-issue-date">...</span></div> <div class="receipt-detail-item"><span>จำนวนเงิน:</span><span id="receipt-amount">...</span></div> <div class="receipt-detail-item"><span>สถานะ:</span><span class="payment-status status-paid"><i class="fas fa-check-circle status-icon"></i>ชำระเรียบร้อย</span></div> <div class="receipt-detail-item"><span>สำหรับงวดที่:</span><span id="receipt-installment-no">...</span></div> </div> <button class="payment-button download-pdf-btn"><i class="fas fa-file-pdf"></i> ดาวน์โหลด PDF</button> <div style="margin-top: 10px; font-size: 0.85rem; color: var(--text-light); text-align: center;">(ข้อมูลตัวอย่าง)</div> </div> </div>

        <div class="container">
            <div class="header-container">
                 <div class="user-greeting" id="user-greeting-container">
                    <div class="user-greeting-top">
                        <div class="greeting-text">
                            <div class="greeting-message-container">
                                <div>
                                    <span class="greeting-time" id="greeting-message">
                                        <i id="greeting-icon" class="fas fa-sun"></i>
                                        <span id="greeting-text-span">...</span>
                                    </span>
                                    <span class="user-name" id="user-name">...</span>
                                </div>
                            </div>
                            <p>ยินดีต้อนรับสู่ระบบสินเชื่อ</p>
                            <div class="contract-info-line">
                                <p class="greeting-contract-number">
                                    <i class="fas fa-file-contract"></i> เลขที่สัญญา: <span id="contract-number-display">...</span>
                                    <span class="contract-status" id="contract-status-badge"></span>
                                </p>
                            </div>
                        </div>
                        <img src="https://via.placeholder.com/75" alt="User Avatar" class="greeting-avatar" id="greeting-avatar">
                    </div>
                    <div class="user-greeting-bottom">
                        <div class="user-greeting-address" id="user-greeting-address-container"> <i class="fas fa-map-marker-alt"></i> <div><strong>ที่อยู่สำหรับจัดส่งเอกสาร:</strong><span id="user-address-display">...</span></div> </div>
                        <div class="greeting-contact-actions"> <a href="#" class="contact-btn call-btn" title="ติดต่อทางโทรศัพท์"><i class="fas fa-phone-alt"></i> <span id="call-btn-text"></span></a> <a href="#" class="contact-btn download-btn" title="ดาวน์โหลดสัญญา"><i class="fas fa-download"></i> <span>ดาวน์โหลดสัญญา</span></a> </div>
                    </div>
                </div>
            </div>

            <div class="contract-selector-section"> <h2 class="contract-selector-title"><i class="fas fa-layer-group"></i> สัญญาของท่าน</h2> <div class="contract-selector-cards" id="contract-selector-cards"> <div style="padding: 20px; color: var(--text-light); text-align: center; width: 100%;">กำลังโหลดข้อมูล...</div> </div> </div>

            <div class="main-content">
                 <div class="card product-info"> <h2 class="card-title"><i class="fas fa-box-open"></i> รายละเอียดหลักประกัน</h2> <img src="https://via.placeholder.com/180" alt="Product Image" class="product-image" id="product-image"> <div class="info-grid"> <div class="info-item"><div class="info-label">ยี่ห้อ</div><div class="info-value" id="product-brand">...</div></div> <div class="info-item"><div class="info-label">ประเภทสินเชื่อ</div><div class="info-value" id="product-type">...</div></div> <div class="info-item"><div class="info-label">ประเภทหลักประกัน</div><div class="info-value" id="product-category">...</div></div> <div class="info-item"><div class="info-label">รุ่น / รายละเอียด</div><div class="info-value" id="product-model">...</div></div> <div class="info-item"><div class="info-label">วงเงินสินเชื่อ</div><div class="info-value" id="loan-amount">...</div></div> <div class="info-item"><div class="info-label">อัตราดอกเบี้ย</div><div class="info-value" id="interest-rate">...</div></div> </div> </div>
                 <div class="card payment-card">
                     <h2 class="card-title"><i class="fas fa-credit-card"></i> ข้อมูลการชำระเงิน</h2>
                     <div class="payment-amount" id="next-payment-amount">0.00 บาท</div>
                     <div class="payment-due" id="next-payment-due"><i class="fas fa-calendar-alt"></i> งวดที่ ... กำหนดชำระ: <strong>...</strong></div>
                     <div id="payment-countdown"></div>
                     <div class="additional-payment-info">
                         <div class="additional-info-item">
                             <span class="additional-info-label"><i class="fas fa-barcode" style="margin-right: 4px;"></i> Bill ID (งวดนี้):</span>
                             <span class="additional-info-value" id="bill-id">...</span>
                         </div>
                         <!-- Late fee display (updated dynamically) -->
                         <div class="additional-info-item">
                             <span class="additional-info-label">ค่าปรับคงค้าง (รวมทุกงวด):</span>
                             <span class="additional-info-value" id="late-fee">0.00 บาท</span>
                         </div>
                         <div class="additional-info-item">
                             <span class="additional-info-label">ยอดผ่อนคงเหลือทั้งหมด:</span>
                             <span class="additional-info-value" id="remaining-balance">0.00 บาท</span>
                         </div>
                         <hr style="border: none; border-top: 1px dashed #e0e8f0; margin: 10px 0;">
                         <div class="additional-info-item original-price">
                            <span class="additional-info-label">ยอดปิดบัญชี (ก่อนหักส่วนลด):</span>
                             <span class="additional-info-value" id="original-close-amount">0.00 บาท</span>
                         </div>
                         <div class="additional-info-item discount-line">
                             <span class="additional-info-label">ส่วนลดปิดบัญชี (จากยอดผ่อน):</span>
                             <span class="additional-info-value" id="discount-amount">- 0.00 บาท</span>
                         </div>
                         <div class="additional-info-item">
                             <span class="additional-info-label">ยอดปิดบัญชี (สุทธิ):</span>
                             <span class="additional-info-value" id="discounted-close-amount">0.00 บาท</span>
                         </div>
                          <small style="display: block; text-align: right; color: var(--text-light); font-size: 0.75rem; margin-top: -5px;">(ยอดผ่อนคงเหลือ + ค่าปรับ + ค่าปลดล็อค(ถ้ามี) - ส่วนลด)</small>
                     </div>
                     <!-- Final payment including late fee -->
                     <div class="final-payment">
                         <span class="final-payment-label">ยอดรวมที่ต้องชำระงวดนี้:</span>
                         <span class="final-payment-value" id="final-payment-this-installment">0.00 บาท</span>
                     </div>
                     <div class="payment-buttons-container">
                         <button class="payment-button" id="payment-button"><i class="fas fa-dollar-sign"></i> ชำระเงินงวดนี้</button>
                         <button class="payment-button postpone-payment-button" id="postpone-payment-button"><i class="fas fa-calendar-day"></i> ขอเลื่อนชำระ</button>
                         <button class="payment-button close-loan-button" id="close-loan-button"><i class="fas fa-door-closed"></i> ปิดบัญชี</button>
                     </div>

                     <!-- Unlock Options Container: Displayed based on past-due status -->
                     <div class="unlock-options" id="unlock-options-container" style="display: none;">
                         <h4><i class="fas fa-lock"></i> เครื่องล็อค! (เกินกำหนดชำระ)</h4>
                         <p>เลือกวิธีปลดล็อคชั่วคราว (มีค่าบริการ):</p>
                         <div class="payment-buttons-container" id="unlock-buttons">
                             <button class="payment-button unlock-btn" data-type="standard" data-fee="100"><i class="fas fa-hourglass-half"></i> ปลดล็อค 2-3 ชม. (100 บ.)</button>
                             <button class="payment-button unlock-btn" data-type="express" data-fee="200"><i class="fas fa-bolt"></i> ปลดล็อค 5-10 นาที (200 บ.)</button>
                         </div>
                          <small style="display: block; text-align: center; color: var(--text-light); font-size: 0.75rem; margin-top: 10px;">(ต้องชำระยอดค้างงวดปัจจุบันก่อน การปลดล็อคจึงจะมีผล)</small>
                     </div>
                     <!-- END: Unlock Options Container -->

                 </div>
                 <div class="card tabbed-card"> <div class="tab-nav"> <button class="tab-link active" data-tab="installment-info-tab"><i class="fas fa-tasks"></i> ข้อมูลการผ่อนชำระ</button> <button class="tab-link" data-tab="history-tab"><i class="fas fa-history"></i> ประวัติการชำระ</button> </div> <div class="tab-content-area"> <div class="tab-content active" id="installment-info-tab"> <h2 class="card-title" style="margin-bottom: 15px; font-size: 1.2rem;">ภาพรวมการผ่อนชำระ</h2> <div class="info-grid"> <div class="info-item"><div class="info-label">จำนวนงวดทั้งหมด</div><div class="info-value" id="total-installments-info">...</div></div> <div class="info-item"><div class="info-label">จำนวนงวดที่ชำระแล้ว (โดยประมาณ)</div><div class="info-value" id="paid-installments-info">...</div></div> <div class="info-item"><div class="info-label">ยอดผ่อนชำระต่องวด</div><div class="info-value" id="installment-amount-info">...</div></div> <div class="info-item"><div class="info-label">จำนวนงวดคงเหลือ (โดยประมาณ)</div><div class="info-value" id="remaining-installments-info">...</div></div> </div> <div class="progress-container"> <div class="progress-info"><span id="progress-text">ความคืบหน้าการชำระ: ...</span><span id="progress-percentage">0%</span></div> <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div> </div> <div class="data-timestamp-container"> <span id="installment-data-timestamp"><i class="fas fa-info-circle"></i> ข้อมูล ณ วันที่ ...</span> <button id="refresh-data-btn" title="รีเฟรชข้อมูล"><i class="fas fa-sync-alt"></i></button> </div> <div class="payment-schedule-table-container"> <h3 style="margin-top: 20px; margin-bottom: 10px; font-size: 1.1rem;">ตารางการผ่อนชำระ</h3> <table class="payment-schedule-table"> <thead> <tr> <th>งวดที่</th> <th>กำหนดชำระ</th> <th>จำนวนเงิน(บาท)</th> <th>สถานะ</th> <th>รายละเอียด</th> <th>การดำเนินการ</th> <!-- New Column --> </tr> </thead> <tbody id="payment-schedule-body"> <tr><td colspan="6" style="text-align: center; padding: 20px;">กำลังโหลดข้อมูล...</td></tr> <!-- Updated colspan --> </tbody> </table> <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 10px; text-align: center;" id="schedule-footer-note">*ตารางแสดงสถานะ ณ วันที่ปัจจุบัน</p> </div> </div> <div class="tab-content" id="history-tab"> <h2 class="card-title" style="margin-bottom: 15px; font-size: 1.2rem;">ประวัติการชำระล่าสุด</h2> <div class="payment-history-container" id="payment-history-list"> <div style="text-align: center; padding: 20px;">กำลังโหลดข้อมูล...</div> </div> <button class="show-more-btn" id="show-more-btn" onclick="toggleMorePayments()" style="display: none;">แสดงรายการทั้งหมด <i class="fas fa-chevron-down"></i></button> </div> </div> </div>
            </div>

             <div class="fab-container"> <div class="fab" title="ติดต่อเจ้าหน้าที่" id="help-button"> <i class="fas fa-headset"></i> </div> <div class="fab-menu" id="fab-menu"> <a href="#" class="fab-menu-item" id="fab-phone-link"> <i class="fas fa-phone-alt fab-phone-icon"></i> <span id="fab-phone-text">...</span> </a> <a href="#" class="fab-menu-item" id="fab-email-link"> <i class="fas fa-envelope fab-email-icon"></i> <span id="fab-email-text">...</span> </a> <a href="#" class="fab-menu-item" id="fab-line-link"> <i class="fab fa-line fab-line-icon"></i> <span id="fab-line-text">...</span> </a> </div> </div>
             <nav class="bottom-nav" id="bottom-nav"> <div class="bottom-nav-items"> <a href="#" class="bottom-nav-item active" onclick="handleNavClick(event, 'home')"> <i class="fas fa-home"></i> <span>หน้าหลัก</span> </a> <a href="#" class="bottom-nav-item" onclick="handleNavClick(event, 'payment')"> <i class="fas fa-credit-card"></i> <span>ชำระเงิน</span> </a> <a href="#" class="bottom-nav-item" onclick="handleNavClick(event, 'history')"> <i class="fas fa-history"></i> <span>ประวัติ</span> </a> <a href="#" class="bottom-nav-item" onclick="handleNavClick(event, 'profile')"> <i class="fas fa-user"></i> <span>โปรไฟล์</span> </a> <a href="#" class="bottom-nav-item" onclick="handleNavClick(event, 'contact')"> <i class="fas fa-headset"></i> <span>ติดต่อเรา</span> </a> </div> </nav>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const installmentsToShowInitially = 5;
        const yourPhoneNumber = "081-234-5678";
        const yourLineIdForFAB = "@yourlineacct";
        const yourEmailAddress = "support@example.com";
        const correctPin = "123456";
        let currentContractId = null;
        let currentNotificationTab = 'app-status';
        let countdownInterval = null;
        const closeLoanDiscountRate = 0.10; // 10% discount on closing early (applies to remaining principal only)
        let isRefreshingData = false;
        let enteredPin = "";
        // Flags for preventing double clicks
        let isActionProcessing = {
            payment: false,
            postpone: false,
            closeLoan: false,
            payEarly: false,
            unlock: false, // Added for unlock buttons
            nav: false
        };
        // State for selected unlock fee (temporary, used by close loan if selected)
        let selectedUnlockFee = 0; // 0 = none, 100 = standard, 200 = express
        const ACTION_COOLDOWN = 1500; // Cooldown time in ms for most buttons
        const EARLY_PAY_COOLDOWN = 1000; // Shorter cooldown for early pay
        const UNLOCK_COOLDOWN = 2000; // Cooldown for unlock buttons

        // --- Sample Contract Data ---
        // Function to get tomorrow's date for the simulation
        function getTomorrowDate() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            //tomorrow.setHours(18, 0, 0, 0); // Set due time to 6 PM tomorrow (for countdown)
            tomorrow.setHours(0,0,0,0); // For date calculation, set to beginning of day
            return tomorrow;
        }

        // Function to calculate the required start date for an installment to be due on a specific date
        function calculateStartDateForDueDate(targetDueDate, installmentNumber) {
            const startDate = new Date(targetDueDate);
            // Subtract (installmentNumber - 1) months from the target due date
            startDate.setMonth(startDate.getMonth() - (installmentNumber - 1));
            // Ensure the day remains consistent
             const originalDay = targetDueDate.getDate();
             const tempDateCheck = new Date(startDate.getFullYear(), startDate.getMonth(), originalDay);
             if (tempDateCheck.getMonth() !== startDate.getMonth()) {
                 // originalDay doesn't exist in this month, set to last day
                 startDate.setDate(0);
             } else {
                startDate.setDate(originalDay); // Set to original start day
             }
             startDate.setHours(0, 0, 0, 0); // Normalize start time
            return startDate;
        }

        // --- VIVO Contract Simulation Setup ---
        const VIVO_CONTRACT_ID = '5024885014114';
        const VIVO_DUE_INSTALLMENT_NUMBER = 10; // Which installment should be due tomorrow
        const vivoTargetDueDate = getTomorrowDate();
        const vivoCalculatedStartDate = calculateStartDateForDueDate(vivoTargetDueDate, VIVO_DUE_INSTALLMENT_NUMBER);
        console.log("Today:", new Date());
        console.log("Simulated VIVO Due Date (Inst", VIVO_DUE_INSTALLMENT_NUMBER ,"):", vivoTargetDueDate);
        console.log("Calculated VIVO Start Date:", vivoCalculatedStartDate);


        const contractsData = [
            // Contract 1 (Mobile) - Adjusted Start Date for "Due Tomorrow" simulation
            {
                id: VIVO_CONTRACT_ID, contractNumber: VIVO_CONTRACT_ID, status: 'active', userName: 'สมศรี กีเรืองแสง', userAvatar: 'https://randomuser.me/api/portraits/women/65.jpg', address: '123/45 หมู่ 6 ถนนสุขุมวิท แขวงบางนา เขตบางนา กรุงเทพมหานคร 10260', billIdBase: 'INV5024885014',
                product: { brand: 'VIVO', type: 'สินเชื่อโทรศัพท์มือถือ', category: 'สมาร์ทโฟน', model: 'Vivo V30 5G 12/256GB', image: 'https://fdn2.gsmarena.com/vv/pics/vivo/vivo-v30-1.jpg', loanAmount: 17880.00, interestRate: '2.00% ต่อเดือน' },
                contractType: 'mobile', installments: { total: 12, amount: 1240.00 },
                startDate: vivoCalculatedStartDate // Use the calculated start date
            },
             // Contract 2 (Refinance) - Make this one slightly late to test late fee display
             {
                id: '6033991015225', contractNumber: '6033991015225', status: 'active', userName: 'สมศรี กีเรืองแสง', userAvatar: 'https://randomuser.me/api/portraits/men/45.jpg', address: '555 หมู่ 1 ต.บางพลีใหญ่ อ.บางพลี จ.สมุทรปราการ 10540', billIdBase: 'INV6033991015',
                product: { brand: 'Samsung', type: 'สินเชื่อรีไฟแนนซ์', category: 'แท็บเล็ต', model: 'Galaxy Tab S9 FE', image: 'https://fdn2.gsmarena.com/vv/pics/samsung/samsung-galaxy-tab-s9-fe-1.jpg', loanAmount: 19900.00, interestRate: '2.10% ต่อเดือน' },
                contractType: 'refinance', installments: { total: 15, amount: 1650.00 },
                // Start date such that installment 3 (due Dec 10) is late if today is Dec 15
                 // Let's make installment 2 late (due Nov 10)
                 startDate: new Date(2024, 9, 10) // Started Oct 10, 2024. Inst 2 due Nov 10.
            },
             // Contract 3 (Pawn)
            {
                id: '7088123456789', contractNumber: '7088123456789', status: 'active', userName: 'สมศรี กีเรืองแสง', userAvatar: 'https://randomuser.me/api/portraits/women/65.jpg', address: '123/45 หมู่ 6 ถนนสุขุมวิท แขวงบางนา เขตบางนา กรุงเทพมหานคร 10260', billIdBase: 'PAWN70881234',
                product: { brand: 'ARORA', type: 'สินเชื่อจำนำ', category: 'ทองคำ', model: 'สร้อยคอ 1 บาท', image: 'https://img.lazcdn.com/g/p/e3b4e076823824e6fef7217031ff7e3f.jpg_720x720q80.jpg', loanAmount: 25000.00, interestRate: '1.50% ต่อเดือน' },
                contractType: 'pawn', installments: { total: 6, amount: 4500.00 },
                startDate: new Date(2024, 10, 5) // Started Nov 5, 2024. Inst 2 due Jan 5, 2025.
            },
             // Contract 4 (Online Pawn)
            {
                id: '8099112233445', contractNumber: '8099112233445', status: 'active', userName: 'สมชาย ใจดี', userAvatar: 'https://randomuser.me/api/portraits/men/45.jpg', address: '555 หมู่ 1 ต.บางพลีใหญ่ อ.บางพลี จ.สมุทรปราการ 10540', billIdBase: 'ONLINE809911',
                product: { brand: 'GUCCI', type: 'สินเชื่อจำนำออนไลน์', category: 'สินค้าแบรนด์เนม', model: 'กระเป๋า ABC', image: 'https://inwfile.com/s-g/kvgr9o.jpg', loanAmount: 12000.00, interestRate: '1.80% ต่อเดือน' },
                contractType: 'online_pawn', installments: { total: 8, amount: 1750.00 },
                startDate: new Date(2024, 8, 20) // Started Sep 20, 2024. Inst 4 due Jan 20, 2025.
            },
             // Contract 5 (Closed Mobile)
            {
                id: '4011773012998', contractNumber: '4011773012998', status: 'closed', userName: 'สมศรี กีเรืองแสง', userAvatar: 'https://randomuser.me/api/portraits/women/65.jpg', address: '123/45 หมู่ 6 ถนนสุขุมวิท แขวงบางนา เขตบางนา กรุงเทพมหานคร 10260', billIdBase: null,
                product: { brand: 'OPPO', type: 'สินเชื่อโทรศัพท์มือถือ', category: 'สมาร์ทโฟน', model: 'Oppo Reno 10 Pro', image: 'https://www.alottechs.com/wp-content/uploads/2025/01/OPPO-Reno10-5G-8GB-256GB-Ice-Blue.webp', loanAmount: 15000.00, interestRate: '1.85% ต่อเดือน' },
                contractType: 'mobile', installments: { total: 10, amount: 1680.00 },
                startDate: new Date(2023, 1, 15) // Started Feb 15, 2023.
            }
        ];
        let notificationsData = [ { id: 1, type: 'due', text: 'แจ้งกำหนดชำระเงินงวดที่ 10 (สัญญา ...114) กำหนดชำระพรุ่งนี้!', timestamp: '5 นาทีที่แล้ว', read: false, category: 'status' }, { id: 2, type: 'paid', text: 'ได้รับชำระเงินงวดที่ 9 (สัญญา ...114) จำนวน 1,240.00 บาท เรียบร้อยแล้ว', timestamp: '1 เดือนที่แล้ว', read: false, category: 'status' }, { id: 3, type: 'promo', text: 'โปรโมชั่นพิเศษ! ส่วนลดดอกเบี้ยเมื่อปิดบัญชีก่อนกำหนด', timestamp: '3 วันที่แล้ว', read: true, category: 'promo' }, { id: 4, type: 'paid', text: 'ได้รับชำระเงินงวดที่ 8 (สัญญา ...114) จำนวน 1,240.00 บาท เรียบร้อยแล้ว', timestamp: '2 เดือนที่แล้ว', read: true, category: 'status' }, { id: 5, type: 'promo', text: 'สิทธิพิเศษสำหรับลูกค้า! ลุ้นรับรางวัลเมื่อชำระตรงตามกำหนด', timestamp: '2 สัปดาห์ที่แล้ว', read: false, category: 'promo' }, { id: 6, type: 'due', text: 'แจ้งเตือน: งวดที่ 2 (สัญญา ...225) เกินกำหนดชำระแล้ว', timestamp: '5 วันที่แล้ว', read: false, category: 'status' }, { id: 7, type: 'closed', text: 'สัญญา ...998 ได้ปิดบัญชีเรียบร้อยแล้ว ขอขอบพระคุณที่ใช้บริการ', timestamp: '2 เดือนที่แล้ว', read: true, category: 'status' }, ];

        // --- Element Selectors (Declared Once) ---
        const DOMElements = {
            pinOverlay: document.getElementById('pin-overlay'), pinDisplay: document.getElementById('pin-display'), pinDots: document.querySelectorAll('#pin-display .pin-dot'),
            pinStatusMessage: document.getElementById('pin-status-message'), // Added PIN Status
            pinError: document.getElementById('pin-error'), keypad: document.getElementById('keypad'),
            mainAppContent: document.querySelector('.main-app-content'), loadingOverlay: document.getElementById('loading-overlay'), appHeader: document.querySelector('.app-header'), appAvatar: document.getElementById('app-avatar'), appLogo: document.getElementById('app-logo'),
            notificationWrapper: document.getElementById('notification-wrapper'), notificationBell: document.getElementById('notification-bell-icon'), notificationCount: document.getElementById('notification-count'), notificationPanel: document.getElementById('notification-panel'), clearAllNotificationsBtn: document.getElementById('clear-all-notifications'), notificationListStatusUl: document.getElementById('notification-list-status'), notificationListPromoUl: document.getElementById('notification-list-promo'),
            appCloseButton: document.getElementById('app-close-button'), contractSelectorCards: document.getElementById('contract-selector-cards'), pageTitle: document.querySelector('title'),
            userGreetingContainer: document.getElementById('user-greeting-container'), greetingMessage: document.getElementById('greeting-message'), greetingIcon: document.getElementById('greeting-icon'), greetingTextSpan: document.getElementById('greeting-text-span'),
            greetingAvatar: document.getElementById('greeting-avatar'), userName: document.getElementById('user-name'), contractNumberDisplay: document.getElementById('contract-number-display'), contractStatusBadge: document.getElementById('contract-status-badge'), callBtnText: document.getElementById('call-btn-text'), userAddressDisplay: document.getElementById('user-address-display'),
            productImage: document.getElementById('product-image'), productBrand: document.getElementById('product-brand'), productType: document.getElementById('product-type'), productCategory: document.getElementById('product-category'), productModel: document.getElementById('product-model'), loanAmount: document.getElementById('loan-amount'), interestRate: document.getElementById('interest-rate'),
            nextPaymentAmount: document.getElementById('next-payment-amount'), nextPaymentDue: document.getElementById('next-payment-due'), paymentCountdown: document.getElementById('payment-countdown'), billId: document.getElementById('bill-id'), lateFee: document.getElementById('late-fee'), remainingBalance: document.getElementById('remaining-balance'), originalCloseAmount: document.getElementById('original-close-amount'), discountAmount: document.getElementById('discount-amount'), discountedCloseAmount: document.getElementById('discounted-close-amount'), finalPaymentThisInstallment: document.getElementById('final-payment-this-installment'),
            paymentButton: document.getElementById('payment-button'), postponePaymentButton: document.getElementById('postpone-payment-button'), closeLoanButton: document.getElementById('close-loan-button'),
            unlockOptionsContainer: document.getElementById('unlock-options-container'), // New unlock container
            unlockButtons: document.getElementById('unlock-buttons'), // New unlock buttons container
            totalInstallmentsInfo: document.getElementById('total-installments-info'), paidInstallmentsInfo: document.getElementById('paid-installments-info'), installmentAmountInfo: document.getElementById('installment-amount-info'), remainingInstallmentsInfo: document.getElementById('remaining-installments-info'),
            progressText: document.getElementById('progress-text'), progressPercentage: document.getElementById('progress-percentage'), progressFill: document.getElementById('progress-fill'), paymentScheduleBody: document.getElementById('payment-schedule-body'), scheduleFooterNote: document.getElementById('schedule-footer-note'), paymentHistoryList: document.getElementById('payment-history-list'), showMoreBtn: document.getElementById('show-more-btn'),
            notificationTabBtns: document.querySelectorAll('.app-header .notification-tab-btn'), helpButton: document.getElementById('help-button'), fabMenu: document.getElementById('fab-menu'), fabPhoneLink: document.getElementById('fab-phone-link'), fabPhoneText: document.getElementById('fab-phone-text'), fabEmailLink: document.getElementById('fab-email-link'), fabEmailText: document.getElementById('fab-email-text'), fabLineLink: document.getElementById('fab-line-link'), fabLineText: document.getElementById('fab-line-text'),
            bottomNav: document.getElementById('bottom-nav'), slipModal: document.getElementById('slip-modal'), receiptModal: document.getElementById('receipt-modal'), slipDetails: document.getElementById('slip-details'), slipImagePlaceholder: document.getElementById('slip-image-placeholder'), receiptDetails: document.getElementById('receipt-details'), receiptDocNo: document.getElementById('receipt-doc-no'), receiptIssueDate: document.getElementById('receipt-issue-date'), receiptAmount: document.getElementById('receipt-amount'), receiptInstallmentNo: document.getElementById('receipt-installment-no'),
            installmentDataTimestamp: document.getElementById('installment-data-timestamp'), refreshDataBtn: document.getElementById('refresh-data-btn')
        };

        // --- Utility Functions ---
        function formatCurrency(amount) { if (typeof amount !== 'number') return '0.00 บาท'; return amount.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' บาท'; }
        function formatDateThai(date) { if (!(date instanceof Date) || isNaN(date)) return '-'; return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }); }
        function formatDateTimeThai(date, includeSeconds = false) { if (!(date instanceof Date) || isNaN(date)) return '--:--'; const options = { hour: '2-digit', minute: '2-digit', hour12: false }; if (includeSeconds) options.second = '2-digit'; const timeString = date.toLocaleTimeString('th-TH', options); return `${formatDateThai(date)} เวลา ${timeString} น.`; }
        function calculateDueDate(startDate, installmentNumber) { // installmentNumber is 1-based
             if (!(startDate instanceof Date) || isNaN(startDate)) return new Date(NaN);
             const dueDate = new Date(startDate);
             const originalDay = startDate.getDate();
             dueDate.setMonth(startDate.getMonth() + (installmentNumber - 1));
             const tempDateCheck = new Date(dueDate.getFullYear(), dueDate.getMonth(), originalDay);
             if (tempDateCheck.getMonth() !== dueDate.getMonth()) {
                 dueDate.setDate(0);
             } else {
                dueDate.setDate(originalDay);
             }
             return dueDate;
        }
        function getContractTypeName(typeCode) { switch(typeCode) { case 'mobile': return 'สินเชื่อโทรศัพท์มือถือ'; case 'refinance': return 'สินเชื่อรีไฟแนนซ์'; case 'pawn': return 'สินเชื่อจำนำ'; case 'online_pawn': return 'สินเชื่อจำนำออนไลน์'; default: return 'สินเชื่อประเภทอื่น'; } }
        function generateInstallmentBillId(baseId, installmentNumber) { if (!baseId) return 'N/A'; return `${baseId}-${String(installmentNumber).padStart(3, '0')}`; }

        // --- Loading ---
        function showLoadingScreen(fullPage = true) { if (fullPage && DOMElements.loadingOverlay) DOMElements.loadingOverlay.classList.add('visible'); }
        function hideLoadingScreen(fullPage = true) { if (fullPage && DOMElements.loadingOverlay) DOMElements.loadingOverlay.classList.remove('visible'); }

        // --- PIN ---
        function updatePinDisplay() { DOMElements.pinDots.forEach((dot, index) => { dot.classList.toggle('filled', index < enteredPin.length); }); }
        function clearPinInput(showError = null) { // Modified to use pinStatusMessage
            enteredPin = "";
            updatePinDisplay();
            if (DOMElements.pinStatusMessage) {
                DOMElements.pinStatusMessage.textContent = showError || '';
                DOMElements.pinStatusMessage.className = 'pin-status-message' + (showError ? ' status-error' : ''); // Add error class if message exists
            }
            if (showError) {
                setTimeout(() => {
                    if (DOMElements.pinStatusMessage && DOMElements.pinStatusMessage.textContent === showError) { // Clear only if it's the same error msg
                        DOMElements.pinStatusMessage.textContent = '';
                        DOMElements.pinStatusMessage.className = 'pin-status-message';
                    }
                }, 2500); // Slightly longer timeout for error display
            }
        }
        function handleKeyPress(key) {
             if (DOMElements.pinStatusMessage) DOMElements.pinStatusMessage.textContent = ''; // Clear status on key press
             DOMElements.pinStatusMessage.className = 'pin-status-message'; // Reset class
             if (key === 'clear') {
                 clearPinInput();
             } else if (key === 'backspace') {
                 enteredPin = enteredPin.slice(0, -1);
                 updatePinDisplay();
             } else if (!isNaN(key) && enteredPin.length < 6) {
                 enteredPin += key;
                 updatePinDisplay();
             }
             if (enteredPin.length === 6) {
                 validatePin();
             }
        }
        function validatePin() {
            if (DOMElements.pinStatusMessage) {
                DOMElements.pinStatusMessage.textContent = 'กำลังตรวจสอบ...';
                DOMElements.pinStatusMessage.className = 'pin-status-message'; // Default info color
            }
            showLoadingScreen(false); // Show spinner briefly

            setTimeout(() => {
                hideLoadingScreen(false);
                if (enteredPin === correctPin) {
                    console.log("PIN Correct!");
                     if (DOMElements.pinStatusMessage) {
                         DOMElements.pinStatusMessage.textContent = 'รหัสถูกต้อง!';
                         DOMElements.pinStatusMessage.className = 'pin-status-message status-success';
                     }
                    setTimeout(() => { // Short delay before hiding overlay
                        if (DOMElements.pinOverlay) DOMElements.pinOverlay.classList.add('hidden');
                        document.body.classList.add('content-visible');
                        startAppInitialization();
                    }, 500); // Delay to show success message

                } else {
                    console.log("PIN Incorrect!");
                    clearPinInput('รหัส PIN ไม่ถูกต้อง กรุณาลองใหม่อีกครั้ง'); // Displays error in status message
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                }
            }, 400); // Simulate validation time
        }
        function setupPinKeypad() { if (!DOMElements.keypad) return; DOMElements.keypad.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (btn?.dataset.key) handleKeyPress(btn.dataset.key); }); document.addEventListener('keydown', (e) => { if (document.body.classList.contains('content-visible')) return; if (e.key >= '0' && e.key <= '9') handleKeyPress(e.key); else if (e.key === 'Backspace') handleKeyPress('backspace'); else if (e.key === 'Enter' && enteredPin.length === 6) validatePin(); else if (e.key === 'Delete' || e.key === 'Escape') handleKeyPress('clear'); }); }

        // --- Data Timestamp ---
        function updateDataTimestamp() { if (DOMElements.installmentDataTimestamp) DOMElements.installmentDataTimestamp.innerHTML = `<i class="fas fa-info-circle"></i> ข้อมูล ณ ${formatDateTimeThai(new Date(), true)}`; } // Corrected text

        // --- Greeting & Time-based Styling (Improved Readability) ---
        function updateGreetingAndStyle() {
            try {
                const hour = new Date().getHours();
                let greetingMsg = "";
                let iconClass = "fas fa-sun";
                let timeClass = "time-afternoon";
                // let iconColorClass = "icon-afternoon"; // Removed, color forced white

                if (hour >= 5 && hour < 12) {
                    greetingMsg = "สวัสดีตอนเช้า"; iconClass = "fas fa-cloud-sun"; timeClass = "time-morning"; //iconColorClass = "icon-morning";
                } else if (hour >= 12 && hour < 18) {
                    greetingMsg = "สวัสดีตอนบ่าย"; iconClass = "fas fa-sun"; timeClass = "time-afternoon"; //iconColorClass = "icon-afternoon";
                } else if (hour >= 18 && hour < 22) {
                    greetingMsg = "สวัสดีตอนเย็น"; iconClass = "fas fa-cloud-moon"; timeClass = "time-evening"; //iconColorClass = "icon-evening";
                } else {
                    greetingMsg = "สวัสดีตอนดึก"; iconClass = "fas fa-moon"; timeClass = "time-night"; //iconColorClass = "icon-night";
                }

                if (DOMElements.greetingTextSpan) DOMElements.greetingTextSpan.textContent = greetingMsg;
                 else console.warn("greetingTextSpan element not found");

                if (DOMElements.greetingIcon) {
                    DOMElements.greetingIcon.className = `fas ${iconClass}`;
                    // DOMElements.greetingIcon.classList.remove('icon-morning', 'icon-afternoon', 'icon-evening', 'icon-night'); // Removed
                    // DOMElements.greetingIcon.classList.add(iconColorClass); // Removed
                } else console.warn("greetingIcon element not found");

                if (DOMElements.userGreetingContainer) {
                    DOMElements.userGreetingContainer.classList.remove('time-morning', 'time-afternoon', 'time-evening', 'time-night');
                    DOMElements.userGreetingContainer.classList.add(timeClass);
                } else console.warn("userGreetingContainer element not found");
            } catch (error) { console.error("Error updating greeting and style:", error); }
        }

        // --- UI Updates ---
        function updateContractStatusUI(contract) {
            const badge = DOMElements.contractStatusBadge;
            const payBtn = DOMElements.paymentButton;
            const closeBtn = DOMElements.closeLoanButton;
            const postponeBtn = DOMElements.postponePaymentButton;
            const unlockContainer = DOMElements.unlockOptionsContainer;
            const countdownEl = DOMElements.paymentCountdown;

            if (!contract) return; // Safety check

            const isActive = contract.status === 'active';
            const currentDueData = getCurrentDueInstallment(contract); // Recalculate here for consistency
            const isCompleted = isActive && currentDueData.status === 'Completed'; // Check if active but fully paid
            const isPayableNow = isActive && (currentDueData.status === 'Due Now' || currentDueData.status === 'Upcoming'); // Allow payment if upcoming or due now
            // Show unlock options IF it's a mobile contract, active, AND countdown shows "past-due"
            const isPastDue = countdownEl?.classList.contains('past-due');
            const showUnlock = isActive && contract.contractType === 'mobile' && isPastDue;

            // Update Badge
            if (badge) {
                badge.className = 'contract-status';
                if (isActive) {
                    badge.classList.add('status-active');
                     if (isCompleted) {
                         badge.innerHTML = `<i class="fas fa-check-double"></i> ชำระครบแล้ว`; // Special status for completed
                     } else {
                         badge.innerHTML = `<i class="fas fa-check-circle"></i> ใช้งานอยู่`;
                     }
                } else if (contract.status === 'closed') {
                    badge.classList.add('status-closed');
                    badge.innerHTML = `<i class="fas fa-times-circle"></i> ปิดสัญญาแล้ว`;
                } else badge.innerHTML = '';
            }

            // Update Button States
            if (payBtn) {
                // Enable payment if it's Due Now or Upcoming
                payBtn.disabled = !isPayableNow || isCompleted || isActionProcessing.payment;
                 if ((!isPayableNow || isCompleted) && isActionProcessing.payment) isActionProcessing.payment = false; // Reset flag if state changed
            }

            if (postponeBtn) {
                // Disable if inactive OR completed OR processing
                postponeBtn.disabled = !isActive || isCompleted || isActionProcessing.postpone;
                 if ((!isActive || isCompleted) && isActionProcessing.postpone) isActionProcessing.postpone = false;
            }
            if (closeBtn) {
                // Disable if inactive OR completed OR processing
                closeBtn.disabled = !isActive || isCompleted || isActionProcessing.closeLoan;
                 if ((!isActive || isCompleted) && isActionProcessing.closeLoan) isActionProcessing.closeLoan = false;
            }

             // Show/hide Unlock Options
             if (unlockContainer) {
                unlockContainer.style.display = showUnlock ? 'block' : 'none';
                 // Reset selected unlock fee when hiding the container
                if (!showUnlock) {
                    selectedUnlockFee = 0;
                }
                // Disable unlock buttons if main payment is processing or unlock is processing, or if not past due
                const unlockBtns = unlockContainer.querySelectorAll('.unlock-btn');
                unlockBtns.forEach(btn => {
                    btn.disabled = !showUnlock || isActionProcessing.payment || isActionProcessing.unlock;
                 });
                 if (!showUnlock && isActionProcessing.unlock) isActionProcessing.unlock = false; // Reset unlock flag if hidden
             } else {
                selectedUnlockFee = 0; // Ensure reset if container doesn't exist
             }

             // Reset flags if contract becomes inactive or completed
              if(!isActive || isCompleted) {
                 isActionProcessing.payment = false; // Reset payment too if completed
                 isActionProcessing.postpone = false;
                 isActionProcessing.closeLoan = false;
                 isActionProcessing.unlock = false; // Also reset unlock
                 selectedUnlockFee = 0; // Reset selected fee
              }
        }

        function animateProgressBar(contract) {
            const fill = DOMElements.progressFill;
            const inst = contract?.installments;
            if (!fill || !contract || !inst || inst.total <= 0) {
                const isClosed = contract?.status === 'closed';
                const finalPaid = isClosed ? inst?.total : 0;
                const finalTotal = isClosed ? inst?.total : (inst?.total || 0);
                 if(fill) fill.style.width = isClosed ? '100%' : '0%';
                if (DOMElements.progressText) DOMElements.progressText.textContent = `ความคืบหน้าการชำระ: ${finalPaid}/${finalTotal}`;
                if (DOMElements.progressPercentage) DOMElements.progressPercentage.textContent = isClosed ? `100%` : `0%`;
                return;
            }

            // Calculate paid based on current date for progress bar
            const currentDate = new Date();
            let actualPaidCount = 0;
             if (contract.status === 'closed') {
                 actualPaidCount = inst.total; // All paid if closed
             } else if (contract.startDate) {
                 for(let i = 1; i <= inst.total; i++){
                     const dueDate = calculateDueDate(contract.startDate, i);
                      if (isNaN(dueDate)) continue;
                      // Consider paid if its due date month is strictly before current month
                      const dueMonthIndex = dueDate.getFullYear() * 12 + dueDate.getMonth();
                      const currentMonthIndex = currentDate.getFullYear() * 12 + currentDate.getMonth();
                     if (dueMonthIndex < currentMonthIndex) {
                         actualPaidCount++;
                     }
                 }
             }
            // Ensure paid count doesn't exceed total
            actualPaidCount = Math.min(actualPaidCount, inst.total);

            const total = inst.total;
            const perc = total > 0 ? (actualPaidCount / total) * 100 : 0;

            if (DOMElements.progressText) DOMElements.progressText.textContent = `ความคืบหน้าการชำระ: ${actualPaidCount}/${total}`;
            if (DOMElements.progressPercentage) DOMElements.progressPercentage.textContent = `${Math.round(perc)}%`;

            const tab = document.getElementById('installment-info-tab');
            const isActiveTab = tab?.classList.contains('active');
            if (isActiveTab) {
                const bar = document.querySelector('.progress-bar');
                if (!bar) return;
                const rect = bar.getBoundingClientRect();
                const isVisible = rect.top < window.innerHeight && rect.bottom >= 0;
                if (isVisible) {
                    fill.style.transition = 'width 1s ease-out';
                    requestAnimationFrame(() => { fill.style.width = `${perc}%`; });
                } else {
                    fill.style.transition = 'none';
                    fill.style.width = `${perc}%`;
                    requestAnimationFrame(() => { fill.style.transition = ''; });
                }
            } else {
                fill.style.transition = 'none';
                fill.style.width = '0%'; // Reset if tab not active
                requestAnimationFrame(() => { fill.style.transition = ''; });
            }
        }
        function setupTabs() { const links = document.querySelectorAll('.tab-link'); const contents = document.querySelectorAll('.tab-content'); if (!links.length || !contents.length) return; links.forEach(link => { link.addEventListener('click', () => { const targetId = link.getAttribute('data-tab'); links.forEach(l => l.classList.remove('active')); contents.forEach(c => c.classList.remove('active')); link.classList.add('active'); const target = document.getElementById(targetId); if (target) { target.classList.add('active'); const contract = contractsData.find(c => c.id === currentContractId); if (targetId === 'installment-info-tab' && contract) setTimeout(() => animateProgressBar(contract), 50); if (targetId === 'history-tab' && contract) toggleMorePayments(true); } }); }); let activeLink = document.querySelector('.tab-link.active'); if (!activeLink && links.length > 0) { activeLink = links[0]; activeLink.classList.add('active'); } if (activeLink) { const activeId = activeLink.getAttribute('data-tab'); const activeContent = document.getElementById(activeId); if (activeContent) { contents.forEach(c => c.classList.remove('active')); activeContent.classList.add('active'); if (activeId === 'installment-info-tab') { const contract = contractsData.find(c => c.id === currentContractId); if (contract) setTimeout(() => animateProgressBar(contract), 100); } } else if (contents.length > 0) { contents[0].classList.add('active'); if (contents[0].id === 'installment-info-tab') { const contract = contractsData.find(c => c.id === currentContractId); if (contract) setTimeout(() => animateProgressBar(contract), 100); } } } }

        // --- Payment History & Schedule (REVISED with dynamic status) ---

        // Function to determine the status of an installment based on current date
        function getInstallmentStatus(installmentNumber, dueDate, contractStartDate) {
            const currentDate = new Date();
             const today = new Date(currentDate); // Clone for date-only comparison
             today.setHours(0, 0, 0, 0);
            const installmentDueDate = new Date(dueDate);
             if (isNaN(installmentDueDate.getTime())) {
                 return { status: 'Error', text: 'ข้อมูลผิดพลาด', class: '', icon: 'fa-question-circle', rowClass: '' };
             }
             const installmentDueDateOnly = new Date(installmentDueDate);
             installmentDueDateOnly.setHours(0, 0, 0, 0); // Compare dates only


             const dueMonthIndex = installmentDueDate.getFullYear() * 12 + installmentDueDate.getMonth();
             const currentMonthIndex = currentDate.getFullYear() * 12 + currentDate.getMonth();

            if (dueMonthIndex < currentMonthIndex) {
                // Due date month is before the current month - considered paid for status display
                 return { status: 'Paid', text: 'ชำระเรียบร้อย', class: 'status-paid', icon: 'fa-check-circle', rowClass: '' };
             } else if (dueMonthIndex === currentMonthIndex) {
                 // Due date month is the current month
                 if (installmentDueDateOnly <= today) {
                     // Due date is today or earlier *this month*
                      // Check if it's exactly tomorrow (for the VIVO scenario)
                     const tomorrow = new Date(today);
                     tomorrow.setDate(today.getDate() + 1);
                     if (installmentDueDateOnly.getTime() === tomorrow.getTime()) {
                        return { status: 'Upcoming', text: 'กำหนดชำระพรุ่งนี้', class: 'status-upcoming', icon: 'fa-clock', rowClass: 'next-due-row' }; // Special case for tomorrow
                     }
                     // Otherwise, it's Due Now or Past Due within this month
                     return { status: 'Due Now', text: 'ถึงกำหนดชำระ', class: 'status-due-now', icon: 'fa-exclamation-circle', rowClass: installmentDueDateOnly < today ? 'past-due-row' : 'next-due-row' }; // Mark as past due row if date < today
                 } else {
                     // Due date is later this month
                     return { status: 'Upcoming', text: 'รอการชำระ', class: 'status-upcoming', icon: 'fa-clock', rowClass: '' };
                 }
            } else {
                 // Due date month is in the future
                 // Check if it's exactly tomorrow (for the VIVO scenario starting near end of month)
                 const tomorrow = new Date(today);
                 tomorrow.setDate(today.getDate() + 1);
                 if (installmentDueDateOnly.getTime() === tomorrow.getTime()) {
                     return { status: 'Upcoming', text: 'กำหนดชำระพรุ่งนี้', class: 'status-upcoming', icon: 'fa-clock', rowClass: 'next-due-row' }; // Special case for tomorrow
                 }
                 return { status: 'Upcoming', text: 'รอการชำระ', class: 'status-upcoming', icon: 'fa-clock', rowClass: '' };
             }
        }

        function generatePaymentHistory(contract) {
            const container = DOMElements.paymentHistoryList;
            if (!container || !contract) return;
            container.innerHTML = ''; // Clear previous items
            let historyData = [];
            const inst = contract.installments;
            const totalInstallments = inst?.total || 0;
            const amount = inst?.amount || 0;
            const currentDate = new Date();

            // Simulate history based on installments due before the current month
            let simulatedPaidCount = 0;
            let simulatedTotalLateFeePaid = 0; // Track late fees paid in history

            for (let i = 1; i <= totalInstallments; i++) {
                 const dueDate = calculateDueDate(contract.startDate, i);
                 if (isNaN(dueDate)) continue;

                 const dueMonth = dueDate.getFullYear() * 12 + dueDate.getMonth();
                 const currentMonth = currentDate.getFullYear() * 12 + currentDate.getMonth();

                 // If due month is past OR contract is closed, assume paid for history generation
                 if (dueMonth < currentMonth || contract.status === 'closed') {
                     simulatedPaidCount++;
                     // Simulate payment date slightly around due date
                     const payDate = new Date(dueDate);
                     let offsetDays = Math.floor(Math.random() * 5) - 1; // -1 to +3 days from due date
                     payDate.setDate(dueDate.getDate() + offsetDays);
                     payDate.setHours(10 + Math.floor(Math.random() * 8), Math.floor(Math.random() * 60), 0);

                     const slip = `https://via.placeholder.com/450x600?text=Slip+${contract.contractNumber.slice(-3)}+${i}`;
                     const receipt = generateInstallmentBillId(contract.billIdBase, i);

                     // Randomly add postpone fee *before* payment (simulate request)
                     if (i > 1 && Math.random() < 0.15) {
                         const pDate = new Date(dueDate); // Assume fee paid around due date
                         pDate.setDate(dueDate.getDate() - Math.floor(Math.random() * 3 + 1)); // Fee paid few days before due
                         pDate.setHours(14, 0, 0);
                         historyData.push({ type: 'fee', feeType: 'postpone', rel: i, date: formatDateTimeThai(pDate), raw: pDate, amt: formatCurrency(50), rawAmt: 50, status: 'paid', icon: 'fa-calendar-day', text: `ค่าธรรมเนียมเลื่อนชำระ (งวดที่ ${i})` });
                     }

                      // Add the installment payment itself
                     historyData.push({ type: 'installment', inst: i, date: formatDateTimeThai(payDate), raw: payDate, amt: formatCurrency(amount), rawAmt: amount, status: 'paid', slip: slip, receipt: receipt, icon: 'fa-file-invoice-dollar', text: `งวดที่ ${i}` });

                     // Add late fee *if* simulated payment date was after due date
                     if (offsetDays > 0) {
                         const daysLate = offsetDays;
                         let actualLateFee = 0;
                         if (daysLate <= 2) { actualLateFee = 50; }
                         else { actualLateFee = 50 + (daysLate - 2) * 100; }

                         if (actualLateFee > 0 && Math.random() < 0.8) { // High chance to show late fee if paid late
                              const lDate = new Date(payDate); // Fee paid on same day as late payment
                              historyData.push({ type: 'fee', feeType: 'late', rel: i, date: formatDateTimeThai(lDate), raw: lDate, amt: formatCurrency(actualLateFee), rawAmt: actualLateFee, status: 'paid', icon: 'fa-exclamation-triangle', text: `ค่าปรับล่าช้า (งวดที่ ${i})` });
                              simulatedTotalLateFeePaid += actualLateFee;
                         }
                     }

                    // Simulate unlock fee payment randomly for past late mobile payments
                    if (contract.contractType === 'mobile' && offsetDays > 0 && Math.random() < 0.2) {
                        const unlockFee = Math.random() < 0.5 ? 100 : 200; // Randomly choose standard or express
                        const uDate = new Date(payDate); // Assume unlock requested same day as payment
                        historyData.push({ type: 'fee', feeType: 'unlock', rel: i, date: formatDateTimeThai(uDate), raw: uDate, amt: formatCurrency(unlockFee), rawAmt: unlockFee, status: 'paid', icon: 'fa-key', text: `ค่าปลดล็อคเครื่อง (งวดที่ ${i})` });
                    }
                 }
            }

            if (historyData.length === 0) {
                 if (contract.status === 'closed') {
                     container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--success-color);"><i class="fas fa-check-circle"></i> สัญญาปิดบัญชีเรียบร้อยแล้ว</div>`;
                 } else {
                     container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-light);">ยังไม่มีประวัติการชำระเงิน</div>`;
                 }
                 if(DOMElements.showMoreBtn) DOMElements.showMoreBtn.style.display = 'none';
                 return;
             }

            historyData.sort((a, b) => b.raw - a.raw); // Sort by date descending

            historyData.forEach((item, index) => {
                const isHidden = index >= installmentsToShowInitially;
                const div = document.createElement('div');
                div.classList.add('payment-item');
                if (isHidden) div.classList.add('hidden-payment'); // Class still added but display:none in CSS

                if (item.type === 'installment') {
                    div.classList.add('payment-item-paid');
                    div.innerHTML = `
                        <div class="payment-item-main">
                            <div class="payment-item-icon"><i class="fas ${item.icon}"></i></div>
                            <div class="payment-item-info">
                                <span class="payment-period">${item.text}</span>
                                <span class="payment-date">ชำระเมื่อ: ${item.date}</span>
                            </div>
                        </div>
                        <div class="payment-item-details">
                            <div class="payment-amount-small">${item.amt}</div>
                            <span class="payment-status status-paid"><i class="fas fa-check-circle status-icon"></i> ชำระเรียบร้อย</span>
                        </div>
                        <div class="payment-item-actions">
                            <button class="view-slip-btn" onclick="showSlip(${item.inst}, '${item.date}', '${item.slip}')"><i class="fas fa-receipt"></i> ดูสลิป</button>
                            <button class="receipt-btn" onclick="showReceipt(${item.inst}, '${item.date}', '${item.receipt}', '${item.amt}', '${formatDateThai(item.raw)}')"><i class="fas fa-file-invoice"></i> ดูใบเสร็จ</button>
                        </div>`;
                } else if (item.type === 'fee') {
                    div.classList.add('payment-item-fee', `fee-type-${item.feeType}`);
                    div.innerHTML = `
                        <div class="payment-item-main">
                            <div class="payment-item-icon"><i class="fas ${item.icon}"></i></div>
                            <div class="payment-item-info">
                                <span class="payment-period">${item.text}</span>
                                <span class="payment-date">ชำระเมื่อ: ${item.date}</span>
                            </div>
                        </div>
                        <div class="payment-item-details">
                            <div class="payment-amount-small">${item.amt}</div>
                            <span class="payment-status"><i class="fas fa-check status-icon"></i> ชำระเรียบร้อย</span>
                        </div>
                        <div class="payment-item-actions"></div>
                    `; // No actions for fee items
                }
                container.appendChild(div);
            });

            toggleMorePayments(true); // Collapse initially
            const btn = DOMElements.showMoreBtn;
            if(btn) {
                const totalItems = historyData.length;
                btn.style.display = totalItems <= installmentsToShowInitially ? 'none' : 'inline-flex';
                if (totalItems > installmentsToShowInitially) { btn.innerHTML = `แสดงรายการทั้งหมด (${totalItems}) <i class="fas fa-chevron-down"></i>`; }
                btn.classList.remove('expanded');
            }
        }

        function toggleMorePayments(forceCollapse = false) {
            const container = DOMElements.paymentHistoryList;
            const btn = DOMElements.showMoreBtn;
            if (!container || !btn || btn.style.display === 'none') return;

            const hiddenItems = container.querySelectorAll('.hidden-payment');
            let isCurrentlyExpanded = btn.classList.contains('expanded');
            let shouldBeExpanded = forceCollapse ? false : !isCurrentlyExpanded;

            hiddenItems.forEach(item => {
                // Use appropriate display style based on screen size (already handled by CSS classes)
                // Just toggle visibility/animation
                item.style.display = shouldBeExpanded ? '' : 'none'; // Remove display:none or set it
                if (shouldBeExpanded) {
                    // Trigger reflow for animation
                    item.style.animation = 'none';
                    requestAnimationFrame(() => {
                        item.style.animation = '';
                        item.style.animation = 'fadeInPayment 0.5s ease-out forwards';
                    });
                } else {
                    item.style.animation = ''; // Clear animation if hiding
                }
            });

            const total = container.querySelectorAll('.payment-item').length;
            btn.innerHTML = shouldBeExpanded ? `ซ่อนรายการ <i class="fas fa-chevron-up"></i>` : `แสดงรายการทั้งหมด (${total}) <i class="fas fa-chevron-down"></i>`;
            btn.classList.toggle('expanded', shouldBeExpanded);
        }


        function generatePaymentSchedule(contract) {
            const body = DOMElements.paymentScheduleBody;
            const note = DOMElements.scheduleFooterNote;
            if (!body || !contract) return;
            body.innerHTML = ''; // Clear previous content

            const { total = 0, amount = 0 } = contract.installments || {};
            const start = contract.startDate;
            let rows = '';
            let currentDueFound = false;
            let upcomingCount = 0;
            let paidCount = 0; // Counts based on getInstallmentStatus

            if (contract.status === 'closed') {
                body.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--success-color);"><i class="fas fa-check-circle"></i> สัญญาปิดบัญชีเรียบร้อยแล้ว</td></tr>`;
                if (note) note.textContent = '';
                return;
            }

             if (total === 0 || !start) {
                 body.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-light);">ไม่พบข้อมูลตารางการผ่อนชำระ</td></tr>`;
                 if(note) note.textContent = '';
                 return;
             }

            for (let i = 1; i <= total; i++) {
                const dueDate = calculateDueDate(start, i);
                if (isNaN(dueDate)) continue;

                const fmtDate = formatDateThai(dueDate);
                const fmtAmt = formatCurrency(amount);
                const installmentBillId = generateInstallmentBillId(contract.billIdBase, i);
                const statusInfo = getInstallmentStatus(i, dueDate, start); // Use the status function

                let detailsHtml = '';
                let actionHtml = '';
                let rowCls = statusInfo.rowClass || '';

                switch (statusInfo.status) {
                    case 'Paid':
                        const paidHistoryItem = Array.from(DOMElements.paymentHistoryList.querySelectorAll('.payment-item.payment-item-paid'))
                            .find(item => {
                                const period = item.querySelector('.payment-period')?.textContent;
                                return period && period.includes(`งวดที่ ${i}`);
                            });
                         const paidDateText = paidHistoryItem ? paidHistoryItem.querySelector('.payment-date')?.textContent.replace('ชำระเมื่อ: ','') : formatDateThai(dueDate); // Fallback

                        detailsHtml = `
                            <span class="paid-date">ชำระเมื่อ: ${paidDateText}</span>
                            <span class="bill-id-display">Bill ID: ${installmentBillId}</span>`;
                        actionHtml = '-'; // No action for paid
                        paidCount++;
                        break;
                    case 'Due Now':
                        detailsHtml = `<span class="bill-id-display">Bill ID: ${installmentBillId}</span>`;
                        actionHtml = '-'; // Action is via main payment card
                        currentDueFound = true;
                        break;
                    case 'Upcoming':
                        detailsHtml = `<span class="bill-id-display">Bill ID: ${installmentBillId}</span>`;
                        // Use statusInfo.text to check for the "พรุ่งนี้" case specifically
                        if (statusInfo.text === 'กำหนดชำระพรุ่งนี้') {
                             actionHtml = '-'; // Action via main card if due tomorrow
                        } else {
                            actionHtml = `<button class="pay-early-btn" data-inst="${i}" data-billid="${installmentBillId}"><i class="fas fa-calendar-check"></i> ชำระล่วงหน้า</button>`;
                        }
                        upcomingCount++;
                        break;
                     default: // Error case
                         detailsHtml = '<span>-</span>';
                         actionHtml = '-';
                }

                rows += `
                    <tr class="${rowCls}">
                        <td data-label="งวดที่">${i}</td>
                        <td data-label="กำหนดชำระ">${fmtDate}</td>
                        <td data-label="จำนวนเงิน (บาท)"><span>${fmtAmt}</span></td>
                        <td data-label="สถานะ"><span class="status-tag ${statusInfo.class}"><i class="fas ${statusInfo.icon} status-icon"></i>${statusInfo.text}</span></td>
                        <td data-label="รายละเอียด"><div>${detailsHtml}</div></td>
                        <td data-label="การดำเนินการ">${actionHtml}</td>
                    </tr>`;
            }

            // Check if all installments are marked as 'Paid' based on status logic
            if (paidCount === total && total > 0) { // Check total > 0
                body.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--success-color);"><i class="fas fa-check-circle"></i> ชำระครบทุกงวดแล้ว</td></tr>`;
                 if(note) note.textContent = '';
             } else {
                 body.innerHTML = rows;
                 if (note) note.textContent = `*ตารางแสดงสถานะ ณ วันที่ปัจจุบัน`;
            }

             // Add event listeners for the newly created buttons
             attachPayEarlyListeners();
        }

        function attachPayEarlyListeners() {
             const earlyPayButtons = DOMElements.paymentScheduleBody.querySelectorAll('.pay-early-btn');
             earlyPayButtons.forEach(button => {
                 // Remove existing listener to prevent duplicates if function is called again
                 button.removeEventListener('click', handlePayEarlyClick);
                 button.addEventListener('click', handlePayEarlyClick);
             });
        }

        function handlePayEarlyClick(event) {
             const button = event.currentTarget;
             if (isActionProcessing.payEarly || button.disabled) return; // Prevent double click/action on disabled

             const installmentNumber = button.dataset.inst;
             const billId = button.dataset.billid;
             const contract = contractsData.find(c => c.id === currentContractId);

             if (contract?.status === 'active') {
                 isActionProcessing.payEarly = true;
                 button.disabled = true;
                 console.log(`Pay Early processing started for Inst: ${installmentNumber}, Bill: ${billId}`);

                 // Simulate action
                 alert(`ดำเนินการชำระเงินล่วงหน้า งวดที่ ${installmentNumber} (Bill ID: ${billId}) สำหรับสัญญา ${contract.contractNumber}... (จำลอง)`);

                 // Re-enable after a short delay
                 setTimeout(() => {
                     isActionProcessing.payEarly = false;
                     // Find the button again in case the DOM was refreshed
                     const currentButton = DOMElements.paymentScheduleBody.querySelector(`.pay-early-btn[data-inst="${installmentNumber}"]`);
                      const currentContract = contractsData.find(c => c.id === currentContractId);
                     // Only re-enable if the button should be enabled based on current state
                     if (currentButton && currentContract?.status === 'active') {
                         // Find the status for this specific installment again
                          const dueDate = calculateDueDate(currentContract.startDate, parseInt(installmentNumber));
                          const statusInfo = getInstallmentStatus(parseInt(installmentNumber), dueDate, currentContract.startDate);
                          // Only enable if it's still 'Upcoming' and NOT 'กำหนดชำระพรุ่งนี้'
                          if (statusInfo.status === 'Upcoming' && statusInfo.text !== 'กำหนดชำระพรุ่งนี้') {
                              currentButton.disabled = false;
                          } else {
                               currentButton.disabled = true; // Keep disabled if status changed or is due tomorrow
                               // Optionally change text if status changed
                               if (statusInfo.status !== 'Upcoming' || statusInfo.text === 'กำหนดชำระพรุ่งนี้') {
                                    currentButton.innerHTML = '-';
                               }
                          }
                     }
                     console.log("Pay Early processing finished.");
                 }, EARLY_PAY_COOLDOWN);
             }
        }


        // --- Payment Countdown (Updated to include seconds) ---
        function startCountdownTimer(targetDate) {
             const el = DOMElements.paymentCountdown;
             if (!el) return;
             if (countdownInterval) clearInterval(countdownInterval);
             if (!targetDate || !(targetDate instanceof Date) || isNaN(targetDate)) {
                 el.innerHTML = '';
                 return;
             }

             const targetTime = new Date(targetDate);
             // Use 6 PM (18:00:00) of the target date as the deadline for the countdown
             const countdownTargetTime = new Date(targetTime);
             countdownTargetTime.setHours(18, 0, 0, 0);

             function update() {
                 if (!document.body.classList.contains('content-visible')) {
                     clearInterval(countdownInterval);
                     return;
                 }
                 const now = new Date();
                 const dist = countdownTargetTime - now;

                 const today = new Date(); today.setHours(0,0,0,0);
                 const targetDateOnly = new Date(targetTime); targetDateOnly.setHours(0,0,0,0);
                 const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);

                 if (dist < 0) {
                      // It's past the 6 PM deadline on the due date or a past due date
                      clearInterval(countdownInterval);
                      el.innerHTML = `<i class="fas fa-exclamation-circle"></i> เกินกำหนดชำระ`;
                      el.className = 'past-due'; // Apply past-due class
                      // Trigger UI update to potentially show unlock options
                      const currentContract = contractsData.find(c => c.id === currentContractId);
                      if(currentContract) updateContractStatusUI(currentContract);
                 } else {
                    el.className = ''; // Remove past-due class if time remaining
                    const d = Math.floor(dist / 864e5);
                    const h = Math.floor((dist % 864e5) / 36e5);
                    const m = Math.floor((dist % 36e5) / 6e4);
                    const s = Math.floor((dist % 6e4) / 1e3); // Calculate seconds

                    let txt = `<i class="fas fa-clock"></i> เหลือเวลาชำระ: `;
                    if (d > 0) txt += `${d} วัน `;
                    txt += `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; // Include seconds
                    el.innerHTML = txt;
                 }
             }
             update();
             countdownInterval = setInterval(update, 1000); // Update every second
         }

        // --- Update Payment Card (REVISED with Late Fee, Close Loan logic, and Unlock Logic) ---
        function getCurrentDueInstallment(contract) {
             // (This function remains the same as the previous version, calculating current status and late fee)
             if (!contract || !contract.startDate) { // Allow checking even if closed for 'Completed' status
                 // For closed contracts, we might still want to know the last installment details for history, but status is Closed
                 if(contract?.status === 'closed'){
                     return { installmentNumber: contract.installments?.total || null, dueDate: null, billId: null, amount: 0, status: 'Closed', lateFee: 0 };
                 }
                 return { installmentNumber: null, dueDate: null, billId: null, amount: 0, status: 'N/A', lateFee: 0 };
             }
             const { total = 0, amount = 0 } = contract.installments || {};
             let currentDue = null;
             let calculatedLateFee = 0; // Represents *currently outstanding* late fee
             const currentDate = new Date();
             const today = new Date(currentDate);
             today.setHours(0, 0, 0, 0);
             let allPaidBasedOnMonth = true; // Track if all past months are covered
             let firstUpcoming = null; // Track the very first upcoming installment

             for (let i = 1; i <= total; i++) {
                 const dueDate = calculateDueDate(contract.startDate, i);
                 if (isNaN(dueDate)) {
                     allPaidBasedOnMonth = false; // Cannot determine status
                     continue;
                 }
                 const installmentDueDate = new Date(dueDate);
                 installmentDueDate.setHours(0, 0, 0, 0);

                 const statusInfo = getInstallmentStatus(i, dueDate, contract.startDate);
                 const installmentBillId = generateInstallmentBillId(contract.billIdBase, i);

                 if (statusInfo.status !== 'Paid') {
                     allPaidBasedOnMonth = false; // Found one that isn't considered 'Paid' for status check
                 }

                 // Store the first upcoming installment found
                 if (contract.status === 'active' && statusInfo.status === 'Upcoming' && !firstUpcoming) {
                    firstUpcoming = { installmentNumber: i, dueDate: dueDate, billId: installmentBillId, amount: amount, status: 'Upcoming', lateFee: 0 };
                 }

                 // Check for Due Now (includes today, tomorrow, or past due in current month)
                 if (contract.status === 'active' && statusInfo.status === 'Due Now') {
                     // Calculate late fee ONLY if the due date is strictly *before* today
                     if (installmentDueDate < today) {
                         const timeDiff = today.getTime() - installmentDueDate.getTime();
                         const daysLate = Math.max(0, Math.floor(timeDiff / (1000 * 60 * 60 * 24)));

                         if (daysLate > 0 && daysLate <= 2) { calculatedLateFee = 50.00; }
                         else if (daysLate > 2) { calculatedLateFee = 50.00 + (daysLate - 2) * 100.00; }
                         else { calculatedLateFee = 0; } // Should not happen if < today
                         console.log(`Installment ${i} is ${daysLate} days late. Fee: ${calculatedLateFee}`);
                     } else {
                        calculatedLateFee = 0; // Due today or earlier this month, but not *before* today
                         console.log(`Installment ${i} is due now, but not past today.`);
                     }
                     // IMPORTANT: For simulation, assume this is the *total* outstanding late fee.
                     // In a real system, you'd sum up all unpaid late fees.
                     currentDue = { installmentNumber: i, dueDate: dueDate, billId: installmentBillId, amount: amount, status: 'Due Now', lateFee: calculatedLateFee };
                     break; // Found the current 'Due Now' installment
                 }
             }

              // After loop, decide what to return
             if (currentDue) {
                 // If we found a 'Due Now' installment, return it
                 return currentDue;
             } else {
                 // No 'Due Now' found
                 if (allPaidBasedOnMonth && total > 0 && contract.status === 'active') {
                    // Check if the last installment's due month is also past
                    const lastDueDate = calculateDueDate(contract.startDate, total);
                    if (!isNaN(lastDueDate)) {
                        const lastDueMonthIndex = lastDueDate.getFullYear() * 12 + lastDueDate.getMonth();
                        const currentMonthIndex = currentDate.getFullYear() * 12 + currentDate.getMonth();
                         if (lastDueMonthIndex < currentMonthIndex) {
                            // All installments are from past months, contract should be considered completed
                            return { installmentNumber: total, dueDate: null, billId: null, amount: 0, status: 'Completed', lateFee: 0 };
                         }
                    }
                     // If last due month is not past, but all previous were paid, look for upcoming
                 }

                // If not completed, check for upcoming
                 if (contract.status === 'active' && firstUpcoming) {
                    // Contract is active, no 'Due Now', but we found an 'Upcoming' one earlier
                    return firstUpcoming; // Return the first upcoming installment details
                 } else if (contract.status === 'closed') {
                     return { installmentNumber: total, dueDate: null, billId: null, amount: 0, status: 'Closed', lateFee: 0 };
                 } else {
                     // Contract is active but no due/upcoming found (maybe error or truly completed)
                     // Check if all installments are from past months again to be sure
                      let trulyCompleted = true;
                      if(contract.status === 'active' && total > 0) {
                          for(let i = 1; i <= total; i++) {
                               const dueDate = calculateDueDate(contract.startDate, i);
                               if (isNaN(dueDate)) { trulyCompleted = false; break; }
                               const dueMonthIndex = dueDate.getFullYear() * 12 + dueDate.getMonth();
                               const currentMonthIndex = currentDate.getFullYear() * 12 + currentDate.getMonth();
                               if(dueMonthIndex >= currentMonthIndex) {
                                   trulyCompleted = false; break;
                               }
                          }
                      } else {
                          trulyCompleted = false; // Not active or no installments
                      }

                     if(trulyCompleted) {
                          return { installmentNumber: total, dueDate: null, billId: null, amount: 0, status: 'Completed', lateFee: 0 };
                     } else {
                         // Default case: Active but no clear next step, or error
                         return { installmentNumber: null, dueDate: null, billId: null, amount: 0, status: 'N/A', lateFee: 0 };
                     }
                 }
             }
         }

        function updatePaymentCard(contract) {
            if (countdownInterval) clearInterval(countdownInterval);
            if (DOMElements.paymentCountdown) DOMElements.paymentCountdown.innerHTML = '';
             if (DOMElements.unlockOptionsContainer) DOMElements.unlockOptionsContainer.style.display = 'none'; // Hide unlock by default

            // Reset selected unlock fee when card updates, unless unlock section remains visible
            if (!DOMElements.unlockOptionsContainer || DOMElements.unlockOptionsContainer.style.display === 'none') {
                selectedUnlockFee = 0;
            }

            const currentDueData = getCurrentDueInstallment(contract);
            const inst = contract?.installments || {};
            const total = inst.total || 0;
            const amount = inst.amount || 0; // Base installment amount

            const isClosed = currentDueData.status === 'Closed';
            const isCompleted = currentDueData.status === 'Completed';

            if (isClosed || isCompleted) {
                const statusTxt = isClosed ? 'ปิดสัญญาแล้ว' : 'ชำระครบแล้ว';
                if(DOMElements.nextPaymentAmount) DOMElements.nextPaymentAmount.textContent = '0.00 บาท';
                if(DOMElements.nextPaymentDue) DOMElements.nextPaymentDue.innerHTML = `<i class="fas fa-check-circle text-success"></i> ${statusTxt}`;
                if(DOMElements.billId) DOMElements.billId.textContent = '-';
                if(DOMElements.lateFee) { DOMElements.lateFee.textContent = '0.00 บาท'; DOMElements.lateFee.style.color = 'var(--text-dark)'; }
                if(DOMElements.remainingBalance) DOMElements.remainingBalance.textContent = '0.00 บาท';
                if(DOMElements.originalCloseAmount) { DOMElements.originalCloseAmount.textContent = '0.00 บาท'; DOMElements.originalCloseAmount.closest('.additional-info-item')?.classList.remove('original-price'); } // Remove strike-through class
                if(DOMElements.discountAmount) DOMElements.discountAmount.textContent = '- 0.00 บาท';
                if(DOMElements.discountedCloseAmount) DOMElements.discountedCloseAmount.textContent = '0.00 บาท';
                if(DOMElements.finalPaymentThisInstallment) DOMElements.finalPaymentThisInstallment.textContent = '0.00 บาท';
                if (DOMElements.paymentCountdown) {
                    DOMElements.paymentCountdown.innerHTML = `<i class="fas fa-check-circle text-success"></i> ${statusTxt}`;
                    DOMElements.paymentCountdown.className = 'completed';
                }
                 updateContractStatusUI(contract); // Update button states (will disable based on closed/completed)
                return;
            }

             // --- Calculations for Active Contract ---
            const { installmentNumber, dueDate, billId, amount: currentAmountBase, status, lateFee: currentLateFee } = currentDueData;

            // Determine amount to display in the large text area
            const displayAmount = (status === 'Due Now' || status === 'Upcoming') ? amount : 0;

            // Calculate total value of remaining installments (principal part for discount)
            let remainingInstCount = 0;
             if (installmentNumber && status !== 'N/A' && status !== 'Completed') {
                 remainingInstCount = total - installmentNumber + 1;
             }
             const remainingInstallmentValue = remainingInstCount * amount;

            // Calculate Close Loan Amount (REVISED)
            // Note: currentLateFee is assumed to be the *total outstanding* late fee for this simulation
            // Note: selectedUnlockFee is updated by the unlock button click handler
            const totalCloseAmountBeforeDiscount = remainingInstallmentValue + currentLateFee + selectedUnlockFee;
            const discount = remainingInstallmentValue * closeLoanDiscountRate; // Discount applies ONLY to remaining installments value
            const finalCloseAmount = totalCloseAmountBeforeDiscount - discount;

            // Final payment for *this* installment (only if Due Now)
             const finalPaymentThisInstallment = (status === 'Due Now' ? amount : 0) + currentLateFee;

            // --- Update UI Elements ---
            if (DOMElements.nextPaymentAmount) DOMElements.nextPaymentAmount.textContent = formatCurrency(displayAmount);
            if (DOMElements.nextPaymentDue) {
                 let dueText = 'N/A';
                  if (installmentNumber && status !== 'N/A' && status !== 'Completed') {
                     const statusText = dueDate ? formatDateThai(dueDate) : '-';
                     let statusPrefix = '';
                     const checkStatus = getInstallmentStatus(installmentNumber, dueDate, contract.startDate); // Re-check for specific text

                     if (status === 'Due Now') statusPrefix = `งวดที่ ${installmentNumber} ถึงกำหนดชำระ: `;
                     else if (status === 'Upcoming') {
                         if (checkStatus.text === 'กำหนดชำระพรุ่งนี้') statusPrefix = `งวดที่ ${installmentNumber} กำหนดชำระพรุ่งนี้: `;
                         else statusPrefix = `งวดถัดไป (${installmentNumber}) กำหนดชำระ: `;
                     }
                     else statusPrefix = `งวดที่ ${installmentNumber} กำหนดชำระ: `; // Fallback

                     dueText = `${statusPrefix}<strong>${statusText}</strong>`;
                 } else {
                     dueText = `สถานะ: ไม่พบข้อมูล`;
                 }
                DOMElements.nextPaymentDue.innerHTML = `<i class="fas fa-calendar-alt"></i> ${dueText}`;
            }
            if (DOMElements.billId) DOMElements.billId.textContent = (status === 'Due Now' || status === 'Upcoming') ? (billId || '-') : '-'; // Show bill ID only if relevant
            if (DOMElements.lateFee) {
                DOMElements.lateFee.textContent = formatCurrency(currentLateFee); // Assumed total outstanding late fee
                DOMElements.lateFee.style.color = currentLateFee > 0 ? 'var(--danger-color)' : 'var(--text-dark)';
            }
            if (DOMElements.remainingBalance) DOMElements.remainingBalance.textContent = formatCurrency(remainingInstallmentValue); // Show value of remaining installments
            if (DOMElements.originalCloseAmount) {
                 DOMElements.originalCloseAmount.textContent = formatCurrency(totalCloseAmountBeforeDiscount);
                 DOMElements.originalCloseAmount.closest('.additional-info-item')?.classList.add('original-price'); // Ensure class for styling
                 // Update label text slightly for clarity
                 const labelElement = DOMElements.originalCloseAmount.closest('.additional-info-item')?.querySelector('.additional-info-label');
                 if(labelElement) labelElement.textContent = 'ยอดปิดบัญชี (ก่อนหักส่วนลด):';
            }
            if (DOMElements.discountAmount) DOMElements.discountAmount.textContent = `- ${formatCurrency(discount)}`;
            if (DOMElements.discountedCloseAmount) {
                 DOMElements.discountedCloseAmount.textContent = formatCurrency(finalCloseAmount); // Show final close amount
                  // Update label text slightly for clarity
                 const labelElement = DOMElements.discountedCloseAmount.closest('.additional-info-item')?.querySelector('.additional-info-label');
                 if(labelElement) labelElement.textContent = 'ยอดปิดบัญชี (สุทธิ):';
            }
            if (DOMElements.finalPaymentThisInstallment) DOMElements.finalPaymentThisInstallment.textContent = formatCurrency(finalPaymentThisInstallment);

             // Start countdown only if the installment is due now or upcoming
            if (dueDate && (status === 'Due Now' || status === 'Upcoming')) {
                 startCountdownTimer(dueDate);
             } else if (DOMElements.paymentCountdown) {
                 DOMElements.paymentCountdown.innerHTML = ''; // Clear if not due or upcoming
             }

             updateContractStatusUI(contract); // Update button states AND unlock section visibility based on calculated status
        }


        // --- Modals ---
        function openModal(id) { const m = document.getElementById(id); if (m && document.body.classList.contains('content-visible')) m.style.display = 'flex'; }
        function closeModal(id) { const m = document.getElementById(id); if (m) m.style.display = 'none'; }
        function showSlip(num, date, url) { if(DOMElements.slipDetails) DOMElements.slipDetails.textContent = `สำหรับงวดที่ ${num} - ${date||'N/A'}`; if(DOMElements.slipImagePlaceholder) DOMElements.slipImagePlaceholder.src = url || 'https://via.placeholder.com/450x600?text=No+Slip+Available'; openModal('slip-modal'); }
        function showReceipt(num, date, doc, amt, issue) { if(DOMElements.receiptDetails) DOMElements.receiptDetails.textContent = `สำหรับงวดที่ ${num} - ${date||'N/A'}`; if(DOMElements.receiptDocNo) DOMElements.receiptDocNo.textContent = doc||'N/A'; if(DOMElements.receiptIssueDate) DOMElements.receiptIssueDate.textContent = issue||date||'N/A'; if(DOMElements.receiptAmount) DOMElements.receiptAmount.textContent = `${amt||'0.00 บาท'}`; if(DOMElements.receiptInstallmentNo) DOMElements.receiptInstallmentNo.textContent = `${num}`; openModal('receipt-modal'); }

        // --- Actions ---
        function setupActionButtons() { const call = document.querySelector('.greeting-contact-actions .call-btn'); const dl = document.querySelector('.greeting-contact-actions .download-btn'); if (call && DOMElements.callBtnText) { const tel = yourPhoneNumber.replace(/[-\s]/g, ''); call.href = `tel:${tel}`; DOMElements.callBtnText.textContent = yourPhoneNumber; } if (dl) { dl.addEventListener('click', (e) => { e.preventDefault(); const c = contractsData.find(con => con.id === currentContractId); alert(`ดำเนินการดาวน์โหลดสัญญา ${c?.contractNumber || 'N/A'}... (จำลอง)`); }); } if (DOMElements.fabPhoneLink) { DOMElements.fabPhoneLink.href = `tel:${yourPhoneNumber.replace(/[-\s]/g, '')}`; if (DOMElements.fabPhoneText) DOMElements.fabPhoneText.textContent = `โทร: ${yourPhoneNumber}`; } if (DOMElements.fabEmailLink) { DOMElements.fabEmailLink.href = `mailto:${yourEmailAddress}`; if (DOMElements.fabEmailText) DOMElements.fabEmailText.textContent = `อีเมล`; } if (DOMElements.fabLineLink) { DOMElements.fabLineLink.href = `https://line.me/ti/p/~${yourLineIdForFAB}`; DOMElements.fabLineLink.target = '_blank'; if (DOMElements.fabLineText) DOMElements.fabLineText.textContent = `LINE: ${yourLineIdForFAB}`; } }

        // --- Notifications ---
        function getIconForType(type) { switch(type) { case 'due': return 'fa-dollar-sign icon-due'; case 'paid': return 'fa-check-circle icon-paid'; case 'promo': return 'fa-gift icon-promo'; case 'closed': return 'fa-check-double icon-closed'; default: return 'fa-info-circle'; } }
        function updateNotificationBadge() { const count = notificationsData.filter(n => !n.read).length; if (DOMElements.notificationCount) { DOMElements.notificationCount.textContent = count; DOMElements.notificationCount.classList.toggle('hidden', count === 0); } }
        function renderNotifications(filterCategory = 'app-status') { const statusList = DOMElements.notificationListStatusUl; const promoList = DOMElements.notificationListPromoUl; if (!statusList || !promoList) return; const statusN = notificationsData.filter(n => n.category === 'status'); const promoN = notificationsData.filter(n => n.category === 'promo'); const render = (ul, N) => { ul.innerHTML = ''; const typeTxt = ul.dataset.type === 'app-promo' ? 'โปรโมชั่น' : 'สถานะ'; if (N.length === 0) { ul.innerHTML = `<li class="notification-item"><div class="notification-item-content" style="text-align:center; color: var(--text-light); width: 100%;">ไม่มีการแจ้งเตือน${typeTxt}</div></li>`; return; } N.sort((a, b) => b.id - a.id);
             N.forEach(n => { const li = document.createElement('li'); li.classList.add('notification-item'); li.dataset.id = n.id; if (!n.read) li.classList.add('unread'); const icon = getIconForType(n.type); li.innerHTML = `<i class="fas ${icon} notification-item-icon"></i><div class="notification-item-content"><div class="notification-item-text">${n.text}</div><div class="notification-item-time">${n.timestamp}</div></div>`; li.addEventListener('click', () => markNotificationAsRead(n.id, li)); ul.appendChild(li); }); }; render(statusList, statusN); render(promoList, promoN); updateNotificationBadge(); switchNotificationTab(currentNotificationTab); }
        function markNotificationAsRead(id, el) { const idx = notificationsData.findIndex(n => n.id == id); if (idx > -1 && !notificationsData[idx].read) { notificationsData[idx].read = true; if (el) el.classList.remove('unread'); updateNotificationBadge(); } console.log("Notification Clicked:", id);
             // Add a small delay or visual cue if needed
        }
        function clearAllNotifications() {
            if (isActionProcessing.nav) return; // Prevent if another action is happening
            isActionProcessing.nav = true; // Use nav flag temporarily
            const cat = currentNotificationTab.replace('app-', '');
            let changed = false;
            notificationsData = notificationsData.map(n => { if (n.category === cat && !n.read) { changed = true; return { ...n, read: true }; } return n; });
            if (changed) { renderNotifications(currentNotificationTab); }
            setTimeout(() => { isActionProcessing.nav = false; }, 500); // Short cooldown
        }
        function switchNotificationTab(target) { currentNotificationTab = target; DOMElements.notificationTabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tabTarget === target)); if(DOMElements.notificationListStatusUl) DOMElements.notificationListStatusUl.classList.toggle('active', target === 'app-status'); if(DOMElements.notificationListPromoUl) DOMElements.notificationListPromoUl.classList.toggle('active', target === 'app-promo'); }
        function toggleNotificationPanel() { if (DOMElements.notificationPanel) { const active = DOMElements.notificationPanel.classList.toggle('active'); if (active) renderNotifications(currentNotificationTab); } }

        // --- FAB ---
        function toggleFabMenu() { if (DOMElements.fabMenu) DOMElements.fabMenu.classList.toggle('active'); }

        // --- Contracts ---
        function populateContractCards(selectedId = null) { const container = DOMElements.contractSelectorCards; if (!container) return; container.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>'; setTimeout(() => { container.innerHTML = ''; const sorted = [...contractsData].sort((a, b) => {
                 if (a.status === 'active' && b.status !== 'active') return -1; if (a.status !== 'active' && b.status === 'active') return 1; return (a.contractNumber || '').localeCompare(b.contractNumber || ''); }); if (sorted.length === 0) { container.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-light); width: 100%;">ไม่พบข้อมูลสัญญา</div>`; return; } sorted.forEach(c => { const card = document.createElement('div'); card.classList.add('contract-card-option', `status-${c.status}`, `contract-type-${c.contractType || 'other'}`); card.dataset.contractId = c.id; if (c.id === selectedId) card.classList.add('active'); const typeName = getContractTypeName(c.contractType); card.innerHTML = `<span class="card-option-number"><i class="fas fa-file-alt"></i> ${c.contractNumber}</span><span class="card-option-model">${c.product.model}</span><span class="card-option-type">${typeName}</span>`; card.addEventListener('click', () => { const id = card.dataset.contractId; if (id !== currentContractId && !isRefreshingData) { showLoadingScreen(); document.querySelectorAll('.contract-card-option.active').forEach(el => el.classList.remove('active')); card.classList.add('active'); currentContractId = id; setTimeout(() => loadContractData(id), 50);
                     } card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }); container.appendChild(card); }); }, 300); }

        function loadContractData(contractId) {
            if (isRefreshingData) return;
            const c = contractsData.find(con => con.id === contractId);
            if (!c) { console.error("Contract not found:", contractId); hideLoadingScreen(); return; }

            currentContractId = c.id;
             selectedUnlockFee = 0; // Reset unlock fee selection when loading new contract
            try {
                if(DOMElements.pageTitle) DOMElements.pageTitle.textContent = `ระบบสินเชื่อ | ${c.contractNumber}`;
                if(DOMElements.appAvatar) DOMElements.appAvatar.src = c.userAvatar || 'https://via.placeholder.com/40';
                if(DOMElements.userName) DOMElements.userName.textContent = 'คุณ ' + (c.userName || 'ลูกค้า');
                if(DOMElements.greetingAvatar) DOMElements.greetingAvatar.src = c.userAvatar || 'https://via.placeholder.com/75';
                if(DOMElements.contractNumberDisplay) DOMElements.contractNumberDisplay.textContent = c.contractNumber;
                if(DOMElements.userAddressDisplay) DOMElements.userAddressDisplay.textContent = c.address || 'N/A';

                updateGreetingAndStyle();

                const p = c.product || {};
                if(DOMElements.productImage) { DOMElements.productImage.src = p.image || 'https://via.placeholder.com/180?text=N/A'; DOMElements.productImage.alt = p.model || 'Product Image'; }
                if(DOMElements.productBrand) DOMElements.productBrand.textContent = p.brand || 'N/A';
                if(DOMElements.productType) DOMElements.productType.textContent = p.type || 'N/A';
                if(DOMElements.productCategory) DOMElements.productCategory.textContent = p.category || 'N/A';
                if(DOMElements.productModel) DOMElements.productModel.textContent = p.model || 'N/A';
                if(DOMElements.loanAmount) DOMElements.loanAmount.textContent = `${formatCurrency(p.loanAmount)}`;
                if(DOMElements.interestRate) DOMElements.interestRate.textContent = p.interestRate || 'N/A';

                const inst = c.installments || {};
                const totalInstallments = inst.total || 0;

                 // Calculate 'actual paid' based on current date for display info
                 const currentDate = new Date();
                 let actualPaidCount = 0;
                 if (c.status === 'closed') {
                     actualPaidCount = totalInstallments; // If closed, all are considered paid
                 } else if(c.startDate) {
                     for(let i = 1; i <= totalInstallments; i++){
                         const dueDate = calculateDueDate(c.startDate, i);
                         if(isNaN(dueDate)) continue;
                         const dueMonthIndex = dueDate.getFullYear() * 12 + dueDate.getMonth();
                         const currentMonthIndex = currentDate.getFullYear() * 12 + currentDate.getMonth();
                         if (dueMonthIndex < currentMonthIndex) {
                             actualPaidCount++;
                         }
                     }
                 }
                 actualPaidCount = Math.min(actualPaidCount, totalInstallments); // Cap at total

                if(DOMElements.totalInstallmentsInfo) DOMElements.totalInstallmentsInfo.textContent = `${totalInstallments} งวด`;
                if(DOMElements.paidInstallmentsInfo) DOMElements.paidInstallmentsInfo.textContent = `${actualPaidCount} งวด`;
                if(DOMElements.installmentAmountInfo) DOMElements.installmentAmountInfo.textContent = `${formatCurrency(inst.amount)}`;
                if(DOMElements.remainingInstallmentsInfo) DOMElements.remainingInstallmentsInfo.textContent = `${Math.max(0, totalInstallments - actualPaidCount)} งวด`;

                // Generate History first (used by Schedule potentially)
                generatePaymentHistory(c);
                // Then generate Schedule (which now uses current date logic)
                generatePaymentSchedule(c);
                // Update Payment Card based on current due info (includes late fee, unlock logic, and completed status handling)
                updatePaymentCard(c);
                // Update other UI parts
                updateDataTimestamp();
                animateProgressBar(c); // Animate based on calculated actualPaidCount
                setupTabs(); // Re-setup tabs if necessary
                // updateContractStatusUI is called within updatePaymentCard

            } catch (error) {
                console.error("Error loading contract data into UI:", error);
                alert("เกิดข้อผิดพลาดในการแสดงข้อมูลสัญญา กรุณาลองใหม่อีกครั้ง");
            } finally {
                 hideLoadingScreen();
            }
        }

        // --- Refresh ---
        function handleRefreshData() {
            if (!currentContractId || isRefreshingData) return;
            isRefreshingData = true;
            const btn = DOMElements.refreshDataBtn;
            const icon = '<i class="fas fa-sync-alt"></i>';
            const loading = '<i class="fas fa-sync-alt fa-spin"></i>';
            if (btn) { btn.disabled = true; btn.innerHTML = loading; btn.classList.add('loading'); }
            console.log("Refreshing data for:", currentContractId);
            showLoadingScreen(true); // Show full screen loading

            setTimeout(() => {
                try {
                     // Simulate fetching new data if needed - for now, just reload existing
                     // In a real app, you'd fetch new data for contractsData[currentContractId] here
                     loadContractData(currentContractId); // This will reset selectedUnlockFee
                     // Potentially refresh notificationsData too
                     // renderNotifications();
                 } catch (error) { console.error("Error during refresh:", error); alert("เกิดข้อผิดพลาดระหว่างการรีเฟรชข้อมูล"); }
                 finally {
                     if (btn) { btn.disabled = false; btn.innerHTML = icon; btn.classList.remove('loading'); }
                     hideLoadingScreen(true);
                     isRefreshingData = false;
                     console.log("Refresh complete.");
                 }
            }, 1000); // Simulate network delay
        }

        // --- Bottom Nav ---
        function handleNavClick(e, target) {
            e.preventDefault();
            if (isActionProcessing.nav) return; // Prevent double click
            isActionProcessing.nav = true;

            document.querySelectorAll('.bottom-nav-item').forEach(i => i.classList.remove('active'));
            e.currentTarget.classList.add('active');
            console.log("Navigation target:", target);
            alert(`คลิกเมนู: ${target} (จำลอง)`);

            // Re-enable after a short delay
            setTimeout(() => { isActionProcessing.nav = false; }, 500); // Shorter cooldown for nav
        }

        // --- App Init ---
        function startAppInitialization() {
            console.log("Starting application initialization...");
             showLoadingScreen();
            try {
                loadInitialData();
            } catch(error) {
                console.error("Error during initial app load:", error);
                alert("เกิดข้อผิดพลาดในการโหลดแอปพลิเคชัน");
                hideLoadingScreen();
                if(DOMElements.mainAppContent) {
                    DOMElements.mainAppContent.innerHTML = '<div class="container"><p class="text-center p-5 text-danger"><strong>เกิดข้อผิดพลาด!</strong> ไม่สามารถโหลดข้อมูลได้</p></div>';
                    DOMElements.mainAppContent.style.opacity = 1;
                    DOMElements.mainAppContent.style.visibility = 'visible';
                }
            }
        }
        function loadInitialData() {
            // Start with the VIVO contract for the simulation
            const initial = contractsData.find(c => c.id === VIVO_CONTRACT_ID) || contractsData.find(c => c.status === 'active') || contractsData[0] || null;
            const initialId = initial ? initial.id : null;

            if (DOMElements.appAvatar) DOMElements.appAvatar.src = initial?.userAvatar || 'https://via.placeholder.com/40';
            if (DOMElements.userName) DOMElements.userName.textContent = 'คุณ ' + (initial?.userName || 'ลูกค้า');

            populateContractCards(initialId);
            setupTabs();
            setupActionButtons();
            renderNotifications(currentNotificationTab);
            updateDataTimestamp();

            if (initialId) {
                loadContractData(initialId); // This will internally call hideLoadingScreen
            } else {
                console.warn("No contracts found.");
                if(DOMElements.mainAppContent) DOMElements.mainAppContent.innerHTML = '<div class="container"><p class="text-center p-5" style="color: var(--text-light);">ไม่พบข้อมูลสัญญา</p></div>';
                hideLoadingScreen();
            }
            closeModal('slip-modal');
            closeModal('receipt-modal');
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setupPinKeypad();
                DOMElements.notificationBell?.addEventListener('click', (e) => { e.stopPropagation(); toggleNotificationPanel(); });
                DOMElements.clearAllNotificationsBtn?.addEventListener('click', (e) => { e.stopPropagation(); clearAllNotifications(); });
                DOMElements.notificationTabBtns.forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); switchNotificationTab(btn.dataset.tabTarget); }); });
                window.addEventListener('click', (e) => {
                    if (DOMElements.notificationPanel?.classList.contains('active')) { if (!DOMElements.notificationWrapper?.contains(e.target)) toggleNotificationPanel(); }
                    if (DOMElements.fabMenu?.classList.contains('active')) { if (!DOMElements.fabMenu.contains(e.target) && !DOMElements.helpButton?.contains(e.target)) toggleFabMenu(); }
                });
                DOMElements.appCloseButton?.addEventListener('click', () => { console.log("Close button clicked."); alert("กรุณาปิดหน้าต่างเบราว์เซอร์นี้"); });
                window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (document.body.classList.contains('content-visible')) { closeModal('slip-modal'); closeModal('receipt-modal'); if (DOMElements.notificationPanel?.classList.contains('active')) toggleNotificationPanel(); if (DOMElements.fabMenu?.classList.contains('active')) toggleFabMenu(); } else if (DOMElements.pinOverlay && !DOMElements.pinOverlay.classList.contains('hidden')) { handleKeyPress('clear'); } } });
                window.addEventListener('scroll', () => { if(document.body.classList.contains('content-visible') && currentContractId) animateProgressBar(contractsData.find(c => c.id === currentContractId)); });
                window.addEventListener('resize', () => { if(document.body.classList.contains('content-visible') && currentContractId) animateProgressBar(contractsData.find(c => c.id === currentContractId)); });

                // --- Button Click Handlers with Double-Click Prevention ---
                DOMElements.paymentButton?.addEventListener('click', () => {
                    if (isActionProcessing.payment || DOMElements.paymentButton.disabled) return;
                    const c = contractsData.find(con => con.id === currentContractId);
                    const currentDueData = getCurrentDueInstallment(c);

                    // Allow payment if Due Now OR Upcoming
                    if (c?.status === 'active' && (currentDueData.status === 'Due Now' || currentDueData.status === 'Upcoming')) {
                        isActionProcessing.payment = true;
                        DOMElements.paymentButton.disabled = true;
                        // Disable other buttons
                        const unlockBtns = DOMElements.unlockButtons?.querySelectorAll('.unlock-btn');
                        unlockBtns?.forEach(btn => btn.disabled = true);
                        if(DOMElements.closeLoanButton) DOMElements.closeLoanButton.disabled = true;
                        if(DOMElements.postponePaymentButton) DOMElements.postponePaymentButton.disabled = true;

                        console.log("Payment processing started...");
                        // Amount to pay is the base amount if upcoming/due, plus late fee ONLY if 'Due Now'
                        const amountToPay = (currentDueData.amount || 0) + (currentDueData.status === 'Due Now' ? currentDueData.lateFee : 0);
                        alert(`ดำเนินการชำระเงินงวดที่ ${currentDueData.installmentNumber} (Bill ID: ${currentDueData.billId || 'N/A'}) ยอดรวม ${formatCurrency(amountToPay)} สำหรับสัญญา ${c.contractNumber}... (จำลอง)`);

                        setTimeout(() => {
                            isActionProcessing.payment = false;
                            // Simulate data refresh after payment to update status
                             // Reset selected unlock fee after successful payment as it's no longer relevant for *this* action
                             selectedUnlockFee = 0;
                            handleRefreshData(); // This will re-enable buttons based on new state
                            console.log("Payment processing finished, triggering refresh.");
                        }, ACTION_COOLDOWN);
                    } else {
                         console.log("Payment button clicked but not 'Due Now' or 'Upcoming'. State:", currentDueData.status);
                    }
                });

                DOMElements.postponePaymentButton?.addEventListener('click', () => {
                    if (isActionProcessing.postpone || DOMElements.postponePaymentButton.disabled) return;
                    const c = contractsData.find(con => con.id === currentContractId);
                     const currentDueData = getCurrentDueInstallment(c);

                    if (c?.status === 'active' && currentDueData.status !== 'Completed') { // Allow postpone if active and not completed
                        isActionProcessing.postpone = true;
                        DOMElements.postponePaymentButton.disabled = true;
                         // Disable other buttons
                        if(DOMElements.paymentButton) DOMElements.paymentButton.disabled = true;
                        if(DOMElements.closeLoanButton) DOMElements.closeLoanButton.disabled = true;
                        const unlockBtns = DOMElements.unlockButtons?.querySelectorAll('.unlock-btn');
                        unlockBtns?.forEach(btn => btn.disabled = true);

                        console.log("Postpone processing started...");
                         alert(`ส่งคำขอเลื่อนชำระงวดที่ ${currentDueData.installmentNumber || '?'} สำหรับสัญญา ${c.contractNumber}... (จำลอง)`);
                        setTimeout(() => {
                            isActionProcessing.postpone = false;
                            // Reset selected unlock fee as postpone action overrides it
                             selectedUnlockFee = 0;
                             // Refresh data to re-evaluate button states
                             handleRefreshData();
                            console.log("Postpone processing finished.");
                        }, ACTION_COOLDOWN);
                    } else {
                        console.log("Postpone button clicked but contract inactive or completed.");
                    }
                });

                DOMElements.closeLoanButton?.addEventListener('click', () => {
                    if (isActionProcessing.closeLoan || DOMElements.closeLoanButton.disabled) return;
                    const c = contractsData.find(con => con.id === currentContractId);
                    const currentDueData = getCurrentDueInstallment(c);

                    if (c?.status === 'active' && currentDueData.status !== 'Completed') {
                        isActionProcessing.closeLoan = true;
                        DOMElements.closeLoanButton.disabled = true;
                         // Disable other buttons
                         if(DOMElements.paymentButton) DOMElements.paymentButton.disabled = true;
                         if(DOMElements.postponePaymentButton) DOMElements.postponePaymentButton.disabled = true;
                         const unlockBtns = DOMElements.unlockButtons?.querySelectorAll('.unlock-btn');
                         unlockBtns?.forEach(btn => btn.disabled = true);

                        // Recalculate closing costs *at the moment of clicking*
                        const { total = 0, amount = 0 } = c.installments || {};
                        let remainingInstCount = 0;
                         if (currentDueData.installmentNumber && currentDueData.status !== 'N/A' && currentDueData.status !== 'Completed') {
                            // Count from the current (due/upcoming) installment to the end
                            remainingInstCount = total - currentDueData.installmentNumber + 1;
                         }
                         const remainingInstallmentValue = remainingInstCount * amount;
                         const currentLateFee = currentDueData.lateFee || 0; // Use the calculated outstanding late fee

                         // Check if unlock options are visible *now* and use selectedUnlockFee
                         const isUnlockVisible = DOMElements.unlockOptionsContainer?.style.display !== 'none';
                         const actualUnlockFeeToCharge = isUnlockVisible ? selectedUnlockFee : 0;
                         console.log(`Closing loan: Unlock visible? ${isUnlockVisible}, Selected unlock fee: ${selectedUnlockFee}, Actual unlock fee to charge: ${actualUnlockFeeToCharge}`);


                         const totalCloseAmountBeforeDiscount = remainingInstallmentValue + currentLateFee + actualUnlockFeeToCharge;
                         const discount = remainingInstallmentValue * closeLoanDiscountRate; // Discount only on remaining installments value
                         const finalCloseAmount = totalCloseAmountBeforeDiscount - discount;

                        console.log("Close loan processing started...");
                        alert(`ดำเนินการปิดบัญชี ยอดสุทธิ ${formatCurrency(finalCloseAmount)} สำหรับสัญญา ${c.contractNumber}... (จำลอง)\n(คำนวณจาก: ยอดผ่อนคงเหลือ ${formatCurrency(remainingInstallmentValue)} + ค่าปรับ ${formatCurrency(currentLateFee)} + ค่าปลดล็อค ${formatCurrency(actualUnlockFeeToCharge)} - ส่วนลด ${formatCurrency(discount)})`);

                        setTimeout(() => {
                             // Simulate contract closure in data
                             const contractIndex = contractsData.findIndex(con => con.id === currentContractId);
                             if (contractIndex > -1) {
                                 contractsData[contractIndex].status = 'closed';
                                 selectedUnlockFee = 0; // Reset unlock fee on closure
                             }
                            isActionProcessing.closeLoan = false;
                            // Refresh to show closed state
                            handleRefreshData();
                            console.log("Close loan processing finished, triggering refresh.");
                         }, ACTION_COOLDOWN);
                     } else {
                        console.log("Close Loan button clicked but contract inactive or completed.");
                     }
                });

                 // --- Unlock Button Click Handlers (REVISED) ---
                 DOMElements.unlockButtons?.addEventListener('click', (event) => {
                     const button = event.target.closest('.unlock-btn');
                     if (!button || isActionProcessing.unlock || button.disabled) return; // Check specific unlock flag

                     const c = contractsData.find(con => con.id === currentContractId);
                     const currentDueData = getCurrentDueInstallment(c);
                     const totalCurrentInstallmentDue = (currentDueData?.status === 'Due Now' ? currentDueData.amount : 0) + (currentDueData?.lateFee || 0);
                     const isPastDue = DOMElements.paymentCountdown?.classList.contains('past-due');


                     // Condition to allow unlock request: Mobile, Active, Past Due
                     if (c?.status === 'active' && c.contractType === 'mobile' && isPastDue) {
                         isActionProcessing.unlock = true;
                         // Disable all unlock buttons AND close loan button temporarily
                         const allUnlockBtns = DOMElements.unlockButtons.querySelectorAll('.unlock-btn');
                         allUnlockBtns.forEach(btn => btn.disabled = true);
                         if (DOMElements.closeLoanButton) DOMElements.closeLoanButton.disabled = true;
                         // Keep payment button enabled if it was enabled (user might pay THEN unlock)

                         const fee = Number(button.dataset.fee);
                         const type = button.dataset.type === 'standard' ? '2-3 ชม.' : '5-10 นาที';

                         // Set the selected fee temporarily, used by close loan if clicked immediately after
                         selectedUnlockFee = fee;
                         console.log(`Unlock fee selected: ${selectedUnlockFee}`);

                         console.log(`Unlock request processing started (${type}). Fee: ${fee}`);
                         alert(`ส่งคำขอปลดล็อค (${type}, ${formatCurrency(fee)}).\n(หมายเหตุ: ต้องชำระยอดค้างงวดปัจจุบัน ${formatCurrency(totalCurrentInstallmentDue)} ก่อน การปลดล็อคจึงจะมีผล) (จำลอง)`);

                         // Update the close loan amounts displayed *immediately* to reflect the selected unlock fee
                         updatePaymentCard(c); // This will now include the selectedUnlockFee in the calculation

                         setTimeout(() => {
                             isActionProcessing.unlock = false;
                              // Re-evaluate button states. Don't reset selectedUnlockFee here immediately.
                             const updatedC = contractsData.find(con => con.id === currentContractId);
                              updateContractStatusUI(updatedC); // Re-enable buttons based on current state
                             console.log("Unlock processing finished.");
                         }, UNLOCK_COOLDOWN);
                     }
                 });
                 // --- End Unlock Button Click Handlers ---

                // Delegate listener for pay early buttons
                DOMElements.paymentScheduleBody?.addEventListener('click', function(event) {
                     if (event.target.closest('.pay-early-btn')) {
                         handlePayEarlyClick(event); // Uses its own flag isActionProcessing.payEarly
                     }
                 });


                DOMElements.helpButton?.addEventListener('click', (e) => { e.stopPropagation(); toggleFabMenu(); });
                DOMElements.refreshDataBtn?.addEventListener('click', handleRefreshData); // Already handles isRefreshingData

                console.log("DOM fully loaded and basic listeners attached.");

            } catch (error) {
                 console.error("Error during DOMContentLoaded setup:", error);
                 document.body.innerHTML = '<p style="padding: 20px; text-align: center; color: red;">เกิดข้อผิดพลาดร้ายแรงในการโหลดหน้าเว็บ</p>';
            }
        });

        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!document.body.classList.contains('content-visible') && DOMElements.loadingOverlay) {
                     hideLoadingScreen();
                     console.log("Fallback: Hiding loading screen after timeout.");
                 }
            }, 6000);
        });

    </script>
</body>
</html>